	!>@author
	!>Paul Connolly, The University of Manchester
	!>@brief
	!>radiation solver routines 
    module radiation
    use numerics_type
    use numerics, only : find_pos, poly_int, romb
    implicit none


		!>@brief
		!>main model prognostic variables for radiation
        type radg
        	integer(i4b) :: year, mon, day, hour, sec
        	integer(i4b) :: doy, diy
        	integer(i4b) :: nprocv
        	real(wp) :: albedo, emiss, lat, lon
        	integer(i4b) :: ns, nl, ntot
            real(wp), dimension(:), allocatable ::	b_s_g, & ! cross section for Rayleigh
            	lambda, lambda_low, lambda_high, delta_lambda, & 
            	nrwbin,niwbin ! bin averaged refractive indices
            real(wp), dimension(:,:,:,:,:,:), allocatable :: bli_read ! absorption by gases
            real(wp), dimension(:), allocatable :: probs_read, lambda_low_read, lambda_high_read, &
                                    h2o_read, press_read, temp_read, molecularWeights_read
            real(wp), dimension(:), allocatable ::	ext_s_g ! extinction for Rayleigh
            real(wp), dimension(:,:,:,:), allocatable :: flux_u, flux_d
            real(wp), dimension(:,:,:), allocatable :: rad_power
            real(wp), dimension(:), allocatable :: sflux_l	
            real(wp), dimension(:), allocatable :: mvrecv	
            real(wp), dimension(:), allocatable :: a,b,c,r,u
            integer(i4b), dimension(:), allocatable :: ipress, itemp
            integer(i4b) :: tdstart,tdend, nh2o, npress, &
                    ntemp, nweights, nmolecule, nbands
            							 
        end type radg

        logical, parameter :: deltaScaling=.true.

		real(wp), parameter :: r_gas=8.314_wp, ma=29.e-3_wp, ra=r_gas / ma, &
		                        mv=18.e-3_wp, &
								t_stp=288._wp, p_stp=101300._wp, navog=6.022e23_wp, &
								sflux=1370._wp, rv=r_gas/mv
		!>@brief
		!>variables for namelist radiation input
        type namelist_rad
        	integer(i4b) :: start_year, start_mon,start_day, &
        					start_hour, start_min, start_sec
        	real(wp) :: lat_ref,lon_ref
        	real(wp) :: asymmetry_water
        	integer(i4b) :: quad_flag
        	character (len=200) :: gases_file='data/bli_data.nc'
        	character (len=200) :: albedo='Urban'
        	character (len=200) :: emissivity='Urban'
            integer(i4b) :: ns,nl
            integer(i4b) :: nmolecule = 8
            integer(i4b), dimension(20) :: moleculeID
            real(wp), dimension(20) :: moleculePPM
            real(wp), dimension(100) :: lambda_read_s
            real(wp), dimension(100) :: lambda_read_l
            real(wp) :: lambda_s_low, lambda_s_high, lambda_l_low, lambda_l_high
            logical :: gas_absorption=.false.
        end type namelist_rad

		integer(i4b), parameter :: nemiss=12, nalb=14

		!>@brief
		!>variables for radiation
        type rad_surf_vars
        	! emissivity
        	real(wp), dimension(nemiss) :: emiss=[1.0,0.99,0.82,0.25,0.1,0.96, &
        									0.94,0.925,0.88,0.96,0.80,0.96]
        	character(len=18), dimension(nemiss) :: emiss_des = &
        	   ["Liquid water       ", &
        		"Fresh snow         ",&
        		"Old snow           ",&
        		"Liquid water clouds",&
        		"Cirrus clouds      ", &
        		"Ice                ", &
        		"Soil               ",&
        		"Grass              ",&
        		"Desert             ",&
        		"Forest             ",&
        		"Concrete           ",&
        		"Urban              "]
        	
        	! albedo
        	real(wp), dimension(nalb) :: albedo= &
        		[0.3,0.05,0.85,0.55,0.6,0.45,0.32,0.125,0.21,0.3,0.225,0.125,0.215,0.185]
        	character(len=20), dimension(nalb) :: albedo_des = &
        		["Earth and atmosphere", &
        		 "Liquid water        ", &
        		 "Fresh snow          ", &
        		 "Old snow            ", &
        		 "Thick clouds        ", &
        		 "Thin clouds         ", &
        		 "Sea ice             ", &
        		 "Soil                ", &
        		 "Grass               ", &
        		 "Desert              ", &
        		 "Forest              ", &
        		 "Asphalt             ", &
        		 "Concrete            ", &
        		 "Urban               "]
        end type rad_surf_vars
        
        
        type(rad_surf_vars) :: rsv

		! declare a namelist rad type
		type(namelist_rad) :: nm2
		! declare a radiation grid type
		type(radg) :: radg1

		integer(i4b) :: diy_s, doy_s
		real(wp), parameter :: h_planck=6.6256e-34_wp, &
					c_light=2.9979e8_wp, &	
			k_boltz=1.38e-23_wp, temp_sun=5778._wp, &
			sigma_sb=2._dp*pi**5*real(k_boltz,dp)**4/(15._dp*real(h_planck,dp)**3*real(c_light,dp)**2), &
			fac_planck=2._dp*real(k_boltz,dp)**4/(real(h_planck,dp)**3*real(c_light,dp)**2)*pi, &
			N_a_0 = (p_stp / (t_stp*ra)) / ma * navog ! number of air molecules per m^3 at stp


							
		real(wp), parameter :: diy_exact = 365.242199_wp
		
		real(wp), parameter :: eps1 = epsilon(1._wp)
		real(wp), dimension(:), allocatable :: flux_down, flux_up
		real(wp), dimension(12) :: di_mn=[31, 28, 31,30,31,30,31,31,30,31,30,31], &
								   di_ml=[31, 29, 31,30,31,30,31,31,30,31,30,31]
								   
		! number of entries in LUT for refractive index of liquid water
		integer(i4b), parameter :: n_rfrl=169
		real(wp), dimension(n_rfrl) :: lam_h2o=[0.200e-6_wp,0.225e-6_wp,0.250e-6_wp,&
		                    0.275e-6_wp,0.300e-6_wp,0.325e-6_wp,0.350e-6_wp,0.375e-6_wp,&
		                    0.400e-6_wp,0.425e-6_wp,0.450e-6_wp,0.475e-6_wp,0.500e-6_wp,&
		                    0.525e-6_wp,0.550e-6_wp,0.575e-6_wp,0.600e-6_wp,0.625e-6_wp,&
		                    0.650e-6_wp,0.675e-6_wp,0.700e-6_wp,0.725e-6_wp,0.750e-6_wp,&
		                    0.775e-6_wp,0.800e-6_wp,0.825e-6_wp,0.850e-6_wp,0.875e-6_wp,&
		                    0.900e-6_wp,0.925e-6_wp,0.950e-6_wp,0.975e-6_wp,1.000e-6_wp,&
		                    1.200e-6_wp,1.400e-6_wp,1.600e-6_wp,1.800e-6_wp,2.000e-6_wp,&
		                    2.200e-6_wp,2.400e-6_wp,2.600e-6_wp,2.650e-6_wp,2.700e-6_wp,&
		                    2.750e-6_wp,2.800e-6_wp,2.850e-6_wp,2.900e-6_wp,2.950e-6_wp,&
		                    3.000e-6_wp,3.050e-6_wp,3.100e-6_wp,3.150e-6_wp,3.200e-6_wp,&
		                    3.250e-6_wp,3.300e-6_wp,3.350e-6_wp,3.400e-6_wp,3.450e-6_wp,&
		                    3.500e-6_wp,3.600e-6_wp,3.700e-6_wp,3.800e-6_wp,3.900e-6_wp,&
		                    4.000e-6_wp,4.100e-6_wp,4.200e-6_wp,4.300e-6_wp,4.400e-6_wp,&
		                    4.500e-6_wp,4.600e-6_wp,4.700e-6_wp,4.800e-6_wp,4.900e-6_wp,&
		                    5.000e-6_wp,5.100e-6_wp,5.200e-6_wp,5.300e-6_wp,5.400e-6_wp,&
		                    5.500e-6_wp,5.600e-6_wp,5.700e-6_wp,5.800e-6_wp,5.900e-6_wp,&
		                    6.000e-6_wp,6.100e-6_wp,6.200e-6_wp,6.300e-6_wp,6.400e-6_wp,&
		                    6.500e-6_wp,6.600e-6_wp,6.700e-6_wp,6.800e-6_wp,6.900e-6_wp,&
		                    7.000e-6_wp,7.100e-6_wp,7.200e-6_wp,7.300e-6_wp,7.400e-6_wp,&
		                    7.500e-6_wp,7.600e-6_wp,7.700e-6_wp,7.800e-6_wp,7.900e-6_wp,&
		                    8.000e-6_wp,8.200e-6_wp,8.400e-6_wp,8.600e-6_wp,8.800e-6_wp,&
		                    9.000e-6_wp,9.200e-6_wp,9.400e-6_wp,9.600e-6_wp,9.800e-6_wp,&
		                    10.000e-6_wp,10.500e-6_wp,11.000e-6_wp,11.500e-6_wp,&
		                    12.000e-6_wp,12.500e-6_wp,13.000e-6_wp,13.500e-6_wp,&
		                    14.000e-6_wp,14.500e-6_wp,15.000e-6_wp,15.500e-6_wp,&
		                    16.000e-6_wp,16.500e-6_wp,17.000e-6_wp,17.500e-6_wp,&
		                    18.000e-6_wp,18.500e-6_wp,19.000e-6_wp,19.500e-6_wp,&
		                    20.000e-6_wp,21.000e-6_wp,22.000e-6_wp,23.000e-6_wp,&
		                    24.000e-6_wp,25.000e-6_wp,26.000e-6_wp,27.000e-6_wp,&
		                    28.000e-6_wp,29.000e-6_wp,30.000e-6_wp,32.000e-6_wp,&
		                    34.000e-6_wp,36.000e-6_wp,38.000e-6_wp,40.000e-6_wp,&
		                    42.000e-6_wp,44.000e-6_wp,46.000e-6_wp,48.000e-6_wp,&
		                    50.000e-6_wp,60.000e-6_wp,70.000e-6_wp,80.000e-6_wp,&
		                    90.000e-6_wp,100.000e-6_wp,110.000e-6_wp,120.000e-6_wp,&
		                    130.000e-6_wp,140.000e-6_wp,150.000e-6_wp,160.000e-6_wp,&
		                    170.000e-6_wp,180.000e-6_wp,190.000e-6_wp,200.000e-6_wp]

		real(wp), dimension(n_rfrl) :: nr_h2o=[1.396_wp,1.373_wp,1.362_wp,1.354_wp,&
		    1.349_wp,1.346_wp,1.343_wp,1.341_wp,1.339_wp,1.338_wp,1.337_wp,1.336_wp,&
		    1.335_wp,1.334_wp,1.333_wp,1.333_wp,1.332_wp,1.332_wp,1.331_wp,1.331_wp,&
		    1.331_wp,1.33_wp,1.33_wp,1.33_wp,1.329_wp,1.329_wp,1.329_wp,1.328_wp,&
		    1.328_wp,1.328_wp,1.327_wp,1.327_wp,1.327_wp,1.324_wp,1.321_wp,1.317_wp,&
		    1.312_wp,1.306_wp,1.296_wp,1.279_wp,1.242_wp,1.219_wp,1.188_wp,1.157_wp,&
		    1.142_wp,1.149_wp,1.201_wp,1.292_wp,1.371_wp,1.426_wp,1.467_wp,1.483_wp,&
		    1.478_wp,1.467_wp,1.45_wp,1.432_wp,1.42_wp,1.41_wp,1.4_wp,1.385_wp,1.374_wp,&
		    1.364_wp,1.357_wp,1.351_wp,1.346_wp,1.342_wp,1.338_wp,1.334_wp,1.332_wp,&
		    1.33_wp,1.33_wp,1.33_wp,1.328_wp,1.325_wp,1.322_wp,1.317_wp,1.312_wp,&
		    1.305_wp,1.298_wp,1.289_wp,1.277_wp,1.262_wp,1.248_wp,1.265_wp,1.319_wp,&
		    1.363_wp,1.357_wp,1.347_wp,1.339_wp,1.334_wp,1.329_wp,1.324_wp,1.321_wp,&
		    1.317_wp,1.314_wp,1.312_wp,1.309_wp,1.307_wp,1.304_wp,1.302_wp,1.299_wp,&
		    1.297_wp,1.294_wp,1.291_wp,1.286_wp,1.281_wp,1.275_wp,1.269_wp,1.262_wp,&
		    1.255_wp,1.247_wp,1.239_wp,1.229_wp,1.218_wp,1.185_wp,1.153_wp,1.126_wp,&
		    1.111_wp,1.123_wp,1.146_wp,1.177_wp,1.21_wp,1.241_wp,1.27_wp,1.297_wp,&
		    1.325_wp,1.351_wp,1.376_wp,1.401_wp,1.423_wp,1.443_wp,1.461_wp,1.476_wp,&
		    1.48_wp,1.487_wp,1.5_wp,1.511_wp,1.521_wp,1.531_wp,1.539_wp,1.545_wp,&
		    1.549_wp,1.551_wp,1.551_wp,1.546_wp,1.536_wp,1.527_wp,1.522_wp,1.519_wp,&
		    1.522_wp,1.53_wp,1.541_wp,1.555_wp,1.587_wp,1.703_wp,1.821_wp,1.886_wp,&
		    1.924_wp,1.957_wp,1.966_wp,2.004_wp,2.036_wp,2.056_wp,2.069_wp,2.081_wp,&
		    2.094_wp,2.107_wp,2.119_wp,2.13_wp]

		real(wp), dimension(n_rfrl) :: ni_h2o=[1.10E-07_wp,4.90E-08_wp,3.35E-08_wp,&
		        2.35E-08_wp,1.60E-08_wp,1.08E-08_wp,6.50E-09_wp,3.50E-09_wp,1.86E-09_wp,&
		        1.30E-09_wp,1.02E-09_wp,9.35E-10_wp,1.00E-09_wp,1.32E-09_wp,1.96E-09_wp,&
		        3.60E-09_wp,1.09E-08_wp,1.39E-08_wp,1.64E-08_wp,2.23E-08_wp,3.35E-08_wp,&
		        9.15E-08_wp,1.56E-07_wp,1.48E-07_wp,1.25E-07_wp,1.82E-07_wp,2.93E-07_wp,&
		        3.91E-07_wp,4.86E-07_wp,1.06E-06_wp,2.93E-06_wp,3.48E-06_wp,2.89E-06_wp,&
		        9.89E-06_wp,1.38E-04_wp,8.55E-05_wp,1.15E-04_wp,1.10E-03_wp,2.89E-04_wp,&
		        9.56E-04_wp,3.17E-03_wp,6.70E-03_wp,0.019_wp,0.059_wp,0.115_wp,0.185_wp,&
		        0.268_wp,0.298_wp,0.272_wp,0.24_wp,0.192_wp,0.135_wp,0.0924_wp,0.061_wp,&
		        0.0368_wp,0.0261_wp,0.0195_wp,0.0132_wp,0.0094_wp,0.00515_wp,0.0036_wp,&
		        0.0034_wp,0.0038_wp,0.0046_wp,0.00562_wp,0.00688_wp,0.00845_wp,0.0103_wp,&
		        0.0134_wp,0.0147_wp,0.0157_wp,0.015_wp,0.0137_wp,0.0124_wp,0.0111_wp,&
		        0.0101_wp,0.0098_wp,0.0103_wp,0.0116_wp,0.0142_wp,0.0203_wp,0.033_wp,&
		        0.0622_wp,0.107_wp,0.131_wp,0.088_wp,0.057_wp,0.0449_wp,0.0392_wp,&
		        0.0356_wp,0.0337_wp,0.0327_wp,0.0322_wp,0.032_wp,0.032_wp,0.0321_wp,&
		        0.0322_wp,0.0324_wp,0.0326_wp,0.0328_wp,0.0331_wp,0.0335_wp,0.0339_wp,&
		        0.0343_wp,0.0351_wp,0.0361_wp,0.0372_wp,0.0385_wp,0.0399_wp,0.0415_wp,&
		        0.0433_wp,0.0454_wp,0.0479_wp,0.0508_wp,0.0662_wp,0.0968_wp,0.142_wp,&
		        0.199_wp,0.259_wp,0.305_wp,0.343_wp,0.37_wp,0.388_wp,0.402_wp,0.414_wp,&
		        0.422_wp,0.428_wp,0.429_wp,0.429_wp,0.426_wp,0.421_wp,0.414_wp,0.404_wp,&
		        0.393_wp,0.382_wp,0.373_wp,0.367_wp,0.361_wp,0.356_wp,0.35_wp,0.344_wp,&
		        0.338_wp,0.333_wp,0.328_wp,0.324_wp,0.329_wp,0.343_wp,0.361_wp,0.385_wp,&
		        0.409_wp,0.436_wp,0.462_wp,0.488_wp,0.514_wp,0.587_wp,0.576_wp,0.547_wp,&
		        0.536_wp,0.532_wp,0.531_wp,0.526_wp,0.514_wp,0.5_wp,0.495_wp,0.496_wp,&
		        0.497_wp,0.499_wp,0.501_wp,0.504_wp]

		! number of entries in LUT for refractive index of ice water
		integer(i4b), parameter :: n_rfri=486
		real(wp), dimension(n_rfri) :: lam_h2oi=[4.4300E-08_wp,4.5100E-08_wp,&
		                    4.5900E-08_wp,4.6800E-08_wp,4.7700E-08_wp,4.8600E-08_wp,&
		                    4.9600E-08_wp,5.0600E-08_wp,5.1700E-08_wp,5.2800E-08_wp,&
		                    5.3900E-08_wp,5.5100E-08_wp,5.6400E-08_wp,5.7700E-08_wp,&
		                    5.9000E-08_wp,6.0500E-08_wp,6.2000E-08_wp,6.3600E-08_wp,&
		                    6.5300E-08_wp,6.7000E-08_wp,6.8900E-08_wp,7.0800E-08_wp,&
		                    7.2900E-08_wp,7.3800E-08_wp,7.5100E-08_wp,7.7500E-08_wp,&
		                    8.0000E-08_wp,8.2700E-08_wp,8.5500E-08_wp,8.8600E-08_wp,&
		                    9.1800E-08_wp,9.3000E-08_wp,9.5400E-08_wp,9.9200E-08_wp,&
		                    1.0330E-07_wp,1.0780E-07_wp,1.1000E-07_wp,1.1270E-07_wp,&
		                    1.1400E-07_wp,1.1810E-07_wp,1.2100E-07_wp,1.2400E-07_wp,&
		                    1.2720E-07_wp,1.2950E-07_wp,1.3050E-07_wp,1.3190E-07_wp,&
		                    1.3330E-07_wp,1.3480E-07_wp,1.3620E-07_wp,1.3700E-07_wp,&
		                    1.3780E-07_wp,1.3870E-07_wp,1.3930E-07_wp,1.4090E-07_wp,&
		                    1.4250E-07_wp,1.4350E-07_wp,1.4420E-07_wp,1.4500E-07_wp,&
		                    1.4590E-07_wp,1.4680E-07_wp,1.4760E-07_wp,1.4800E-07_wp,&
		                    1.4850E-07_wp,1.4940E-07_wp,1.5120E-07_wp,1.5310E-07_wp,&
		                    1.5400E-07_wp,1.5500E-07_wp,1.5690E-07_wp,1.5800E-07_wp,&
		                    1.5890E-07_wp,1.6100E-07_wp,1.6300E-07_wp,1.6500E-07_wp,&
		                    1.6700E-07_wp,1.6900E-07_wp,1.7100E-07_wp,1.7300E-07_wp,&
		                    1.7500E-07_wp,1.7700E-07_wp,1.7900E-07_wp,1.8100E-07_wp,&
		                    1.8300E-07_wp,1.8500E-07_wp,1.8700E-07_wp,1.8900E-07_wp,&
		                    1.9100E-07_wp,1.9300E-07_wp,1.9500E-07_wp,1.9700E-07_wp,&
		                    1.9900E-07_wp,2.0100E-07_wp,2.0190E-07_wp,2.1000E-07_wp,&
		                    2.5000E-07_wp,3.0000E-07_wp,3.5000E-07_wp,3.9000E-07_wp,&
		                    4.0000E-07_wp,4.1000E-07_wp,4.2000E-07_wp,4.3000E-07_wp,&
		                    4.4000E-07_wp,4.5000E-07_wp,4.6000E-07_wp,4.7000E-07_wp,&
		                    4.8000E-07_wp,4.9000E-07_wp,5.0000E-07_wp,5.1000E-07_wp,&
		                    5.2000E-07_wp,5.3000E-07_wp,5.4000E-07_wp,5.5000E-07_wp,&
		                    5.6000E-07_wp,5.7000E-07_wp,5.8000E-07_wp,5.9000E-07_wp,&
		                    6.0000E-07_wp,6.1000E-07_wp,6.2000E-07_wp,6.3000E-07_wp,&
		                    6.4000E-07_wp,6.5000E-07_wp,6.6000E-07_wp,6.7000E-07_wp,&
		                    6.8000E-07_wp,6.9000E-07_wp,7.0000E-07_wp,7.1000E-07_wp,&
		                    7.2000E-07_wp,7.3000E-07_wp,7.4000E-07_wp,7.5000E-07_wp,&
		                    7.6000E-07_wp,7.7000E-07_wp,7.8000E-07_wp,7.9000E-07_wp,&
		                    8.0000E-07_wp,8.1000E-07_wp,8.2000E-07_wp,8.3000E-07_wp,&
		                    8.4000E-07_wp,8.5000E-07_wp,8.6000E-07_wp,8.7000E-07_wp,&
		                    8.8000E-07_wp,8.9000E-07_wp,9.0000E-07_wp,9.1000E-07_wp,&
		                    9.2000E-07_wp,9.3000E-07_wp,9.4000E-07_wp,9.5000E-07_wp,&
		                    9.6000E-07_wp,9.7000E-07_wp,9.8000E-07_wp,9.9000E-07_wp,&
		                    1.0000E-06_wp,1.0100E-06_wp,1.0200E-06_wp,1.0300E-06_wp,&
		                    1.0400E-06_wp,1.0500E-06_wp,1.0600E-06_wp,1.0700E-06_wp,&
		                    1.0800E-06_wp,1.0900E-06_wp,1.1000E-06_wp,1.1100E-06_wp,&
		                    1.1200E-06_wp,1.1300E-06_wp,1.1400E-06_wp,1.1500E-06_wp,&
		                    1.1600E-06_wp,1.1700E-06_wp,1.1800E-06_wp,1.1900E-06_wp,&
		                    1.2000E-06_wp,1.2100E-06_wp,1.2200E-06_wp,1.2300E-06_wp,&
		                    1.2400E-06_wp,1.2500E-06_wp,1.2600E-06_wp,1.2700E-06_wp,&
		                    1.2800E-06_wp,1.2900E-06_wp,1.3000E-06_wp,1.3100E-06_wp,&
		                    1.3200E-06_wp,1.3300E-06_wp,1.3400E-06_wp,1.3500E-06_wp,&
		                    1.3600E-06_wp,1.3700E-06_wp,1.3800E-06_wp,1.3900E-06_wp,&
		                    1.4000E-06_wp,1.4100E-06_wp,1.4200E-06_wp,1.4300E-06_wp,&
		                    1.4400E-06_wp,1.4490E-06_wp,1.4600E-06_wp,1.4710E-06_wp,&
		                    1.4810E-06_wp,1.4930E-06_wp,1.5040E-06_wp,1.5150E-06_wp,&
		                    1.5270E-06_wp,1.5380E-06_wp,1.5630E-06_wp,1.5870E-06_wp,&
		                    1.6130E-06_wp,1.6500E-06_wp,1.6800E-06_wp,1.7000E-06_wp,&
		                    1.7300E-06_wp,1.7600E-06_wp,1.8000E-06_wp,1.8300E-06_wp,&
		                    1.8400E-06_wp,1.8500E-06_wp,1.8550E-06_wp,1.8600E-06_wp,&
		                    1.8700E-06_wp,1.8900E-06_wp,1.9050E-06_wp,1.9230E-06_wp,&
		                    1.9420E-06_wp,1.9610E-06_wp,1.9800E-06_wp,2.0000E-06_wp,&
		                    2.0200E-06_wp,2.0410E-06_wp,2.0620E-06_wp,2.0830E-06_wp,&
		                    2.1050E-06_wp,2.1300E-06_wp,2.1500E-06_wp,2.1700E-06_wp,&
		                    2.1900E-06_wp,2.2200E-06_wp,2.2400E-06_wp,2.2450E-06_wp,&
		                    2.2500E-06_wp,2.2600E-06_wp,2.2700E-06_wp,2.2900E-06_wp,&
		                    2.3100E-06_wp,2.3300E-06_wp,2.3500E-06_wp,2.3700E-06_wp,&
		                    2.3900E-06_wp,2.4100E-06_wp,2.4300E-06_wp,2.4600E-06_wp,&
		                    2.5000E-06_wp,2.5200E-06_wp,2.5500E-06_wp,2.5650E-06_wp,&
		                    2.5800E-06_wp,2.5900E-06_wp,2.6000E-06_wp,2.6200E-06_wp,&
		                    2.6750E-06_wp,2.7250E-06_wp,2.7780E-06_wp,2.8170E-06_wp,&
		                    2.8330E-06_wp,2.8490E-06_wp,2.8650E-06_wp,2.8820E-06_wp,&
		                    2.8990E-06_wp,2.9150E-06_wp,2.9330E-06_wp,2.9500E-06_wp,&
		                    2.9670E-06_wp,2.9850E-06_wp,3.0030E-06_wp,3.0210E-06_wp,&
		                    3.0400E-06_wp,3.0580E-06_wp,3.0770E-06_wp,3.0960E-06_wp,&
		                    3.1150E-06_wp,3.1350E-06_wp,3.1550E-06_wp,3.1750E-06_wp,&
		                    3.1950E-06_wp,3.2150E-06_wp,3.2360E-06_wp,3.2570E-06_wp,&
		                    3.2790E-06_wp,3.3000E-06_wp,3.3220E-06_wp,3.3450E-06_wp,&
		                    3.3670E-06_wp,3.3900E-06_wp,3.4130E-06_wp,3.4360E-06_wp,&
		                    3.4600E-06_wp,3.4840E-06_wp,3.5090E-06_wp,3.5340E-06_wp,&
		                    3.5590E-06_wp,3.6240E-06_wp,3.7320E-06_wp,3.7750E-06_wp,&
		                    3.8470E-06_wp,3.9690E-06_wp,4.0990E-06_wp,4.2390E-06_wp,&
		                    4.3480E-06_wp,4.3870E-06_wp,4.4440E-06_wp,4.5050E-06_wp,&
		                    4.5470E-06_wp,4.5600E-06_wp,4.5800E-06_wp,4.7190E-06_wp,&
		                    4.9040E-06_wp,5.0000E-06_wp,5.1000E-06_wp,5.2000E-06_wp,&
		                    5.2630E-06_wp,5.4000E-06_wp,5.5560E-06_wp,5.7140E-06_wp,&
		                    5.7470E-06_wp,5.7800E-06_wp,5.8140E-06_wp,5.8480E-06_wp,&
		                    5.8820E-06_wp,6.0610E-06_wp,6.1350E-06_wp,6.2500E-06_wp,&
		                    6.2890E-06_wp,6.3290E-06_wp,6.3690E-06_wp,6.4100E-06_wp,&
		                    6.4520E-06_wp,6.4940E-06_wp,6.5790E-06_wp,6.6670E-06_wp,&
		                    6.7570E-06_wp,6.8970E-06_wp,7.0420E-06_wp,7.1430E-06_wp,&
		                    7.2460E-06_wp,7.3530E-06_wp,7.4630E-06_wp,7.5760E-06_wp,&
		                    7.6920E-06_wp,7.8120E-06_wp,7.9370E-06_wp,8.0650E-06_wp,&
		                    8.1970E-06_wp,8.3330E-06_wp,8.4750E-06_wp,8.6960E-06_wp,&
		                    8.9290E-06_wp,9.0910E-06_wp,9.2590E-06_wp,9.5240E-06_wp,&
		                    9.8040E-06_wp,1.0000E-05_wp,1.0200E-05_wp,1.0310E-05_wp,&
		                    1.0420E-05_wp,1.0530E-05_wp,1.0640E-05_wp,1.0750E-05_wp,&
		                    1.0870E-05_wp,1.1000E-05_wp,1.1110E-05_wp,1.1360E-05_wp,&
		                    1.1630E-05_wp,1.1900E-05_wp,1.2200E-05_wp,1.2500E-05_wp,&
		                    1.2820E-05_wp,1.2990E-05_wp,1.3160E-05_wp,1.3330E-05_wp,&
		                    1.3510E-05_wp,1.3700E-05_wp,1.3890E-05_wp,1.4080E-05_wp,&
		                    1.4290E-05_wp,1.4710E-05_wp,1.5150E-05_wp,1.5380E-05_wp,&
		                    1.5630E-05_wp,1.6130E-05_wp,1.6390E-05_wp,1.6670E-05_wp,&
		                    1.6950E-05_wp,1.7240E-05_wp,1.8180E-05_wp,1.8320E-05_wp,&
		                    1.8610E-05_wp,1.8870E-05_wp,1.9230E-05_wp,1.9610E-05_wp,&
		                    2.0000E-05_wp,2.0410E-05_wp,2.0830E-05_wp,2.2220E-05_wp,&
		                    2.2600E-05_wp,2.3050E-05_wp,2.3600E-05_wp,2.4600E-05_wp,&
		                    2.5000E-05_wp,2.6000E-05_wp,2.8570E-05_wp,3.1000E-05_wp,&
		                    3.3330E-05_wp,3.4480E-05_wp,3.5640E-05_wp,3.7000E-05_wp,&
		                    3.8240E-05_wp,3.9600E-05_wp,4.1140E-05_wp,4.2760E-05_wp,&
		                    4.3580E-05_wp,4.4580E-05_wp,4.5500E-05_wp,4.6150E-05_wp,&
		                    4.6710E-05_wp,4.7360E-05_wp,4.8000E-05_wp,4.8780E-05_wp,&
		                    5.0030E-05_wp,5.1280E-05_wp,5.2750E-05_wp,5.3500E-05_wp,&
		                    5.4240E-05_wp,5.5000E-05_wp,5.5740E-05_wp,5.6400E-05_wp,&
		                    5.7000E-05_wp,5.7460E-05_wp,5.8400E-05_wp,5.9290E-05_wp,&
		                    6.0000E-05_wp,6.1000E-05_wp,6.1250E-05_wp,6.2500E-05_wp,&
		                    6.3780E-05_wp,6.4670E-05_wp,6.5580E-05_wp,6.6550E-05_wp,&
		                    6.7600E-05_wp,6.9000E-05_wp,7.0530E-05_wp,7.3000E-05_wp,&
		                    7.5000E-05_wp,7.6290E-05_wp,8.0000E-05_wp,8.2970E-05_wp,&
		                    8.5000E-05_wp,8.6800E-05_wp,9.0800E-05_wp,9.5170E-05_wp,&
		                    1.0000E-04_wp,1.2000E-04_wp,1.6000E-04_wp,2.1000E-04_wp,&
		                    3.0000E-04_wp,5.0000E-04_wp,1.3000E-03_wp,5.0000E-03_wp,&
		                    1.9000E-02_wp,3.9000E-02_wp,6.1000E-02_wp,8.6000E-02_wp,&
		                    1.1000E-01_wp,1.4000E-01_wp,1.8000E-01_wp,2.4000E-01_wp,&
		                    3.4000E-01_wp,5.4000E-01_wp,1.0000E+00_wp,2.0000E+00_wp]
		                    
		real(wp), dimension(n_rfri) :: nr_h2oi=[8.2280E-01_wp,8.2500E-01_wp,&
		                    8.2550E-01_wp,8.2580E-01_wp,8.2630E-01_wp,8.2810E-01_wp,&
		                    8.3470E-01_wp,8.4280E-01_wp,8.4830E-01_wp,8.5050E-01_wp,&
		                    8.4970E-01_wp,8.4890E-01_wp,8.5190E-01_wp,8.5660E-01_wp,&
		                    8.6470E-01_wp,8.7970E-01_wp,8.9700E-01_wp,9.1730E-01_wp,&
		                    9.4000E-01_wp,9.6790E-01_wp,1.0093E+00_wp,1.0536E+00_wp,&
		                    1.0986E+00_wp,1.1183E+00_wp,1.1449E+00_wp,1.1885E+00_wp,&
		                    1.2273E+00_wp,1.2629E+00_wp,1.3117E+00_wp,1.3807E+00_wp,&
		                    1.4091E+00_wp,1.4028E+00_wp,1.3948E+00_wp,1.3964E+00_wp,&
		                    1.4047E+00_wp,1.3981E+00_wp,1.3886E+00_wp,1.3806E+00_wp,&
		                    1.3772E+00_wp,1.3783E+00_wp,1.3929E+00_wp,1.4061E+00_wp,&
		                    1.3999E+00_wp,1.3777E+00_wp,1.3607E+00_wp,1.3389E+00_wp,&
		                    1.3210E+00_wp,1.3030E+00_wp,1.2871E+00_wp,1.2849E+00_wp,&
		                    1.2851E+00_wp,1.2970E+00_wp,1.3151E+00_wp,1.3575E+00_wp,&
		                    1.4130E+00_wp,1.4525E+00_wp,1.4845E+00_wp,1.5157E+00_wp,&
		                    1.5484E+00_wp,1.5729E+00_wp,1.5915E+00_wp,1.6021E+00_wp,&
		                    1.6077E+00_wp,1.6156E+00_wp,1.6220E+00_wp,1.6311E+00_wp,&
		                    1.6345E+00_wp,1.6363E+00_wp,1.6353E+00_wp,1.6309E+00_wp,&
		                    1.6214E+00_wp,1.5818E+00_wp,1.5482E+00_wp,1.5225E+00_wp,&
		                    1.5027E+00_wp,1.4870E+00_wp,1.4743E+00_wp,1.4635E+00_wp,&
		                    1.4543E+00_wp,1.4462E+00_wp,1.4390E+00_wp,1.4326E+00_wp,&
		                    1.4268E+00_wp,1.4215E+00_wp,1.4167E+00_wp,1.4122E+00_wp,&
		                    1.4081E+00_wp,1.4043E+00_wp,1.4007E+00_wp,1.3974E+00_wp,&
		                    1.3943E+00_wp,1.3914E+00_wp,1.3901E+00_wp,1.3801E+00_wp,&
		                    1.3509E+00_wp,1.3339E+00_wp,1.3249E+00_wp,1.3203E+00_wp,&
		                    1.3194E+00_wp,1.3185E+00_wp,1.3177E+00_wp,1.3170E+00_wp,&
		                    1.3163E+00_wp,1.3157E+00_wp,1.3151E+00_wp,1.3145E+00_wp,&
		                    1.3140E+00_wp,1.3135E+00_wp,1.3130E+00_wp,1.3126E+00_wp,&
		                    1.3121E+00_wp,1.3117E+00_wp,1.3114E+00_wp,1.3110E+00_wp,&
		                    1.3106E+00_wp,1.3103E+00_wp,1.3100E+00_wp,1.3097E+00_wp,&
		                    1.3094E+00_wp,1.3091E+00_wp,1.3088E+00_wp,1.3085E+00_wp,&
		                    1.3083E+00_wp,1.3080E+00_wp,1.3078E+00_wp,1.3076E+00_wp,&
		                    1.3073E+00_wp,1.3071E+00_wp,1.3069E+00_wp,1.3067E+00_wp,&
		                    1.3065E+00_wp,1.3062E+00_wp,1.3060E+00_wp,1.3059E+00_wp,&
		                    1.3057E+00_wp,1.3055E+00_wp,1.3053E+00_wp,1.3051E+00_wp,&
		                    1.3049E+00_wp,1.3047E+00_wp,1.3046E+00_wp,1.3044E+00_wp,&
		                    1.3042E+00_wp,1.3040E+00_wp,1.3039E+00_wp,1.3037E+00_wp,&
		                    1.3035E+00_wp,1.3033E+00_wp,1.3032E+00_wp,1.3030E+00_wp,&
		                    1.3028E+00_wp,1.3027E+00_wp,1.3025E+00_wp,1.3023E+00_wp,&
		                    1.3022E+00_wp,1.3020E+00_wp,1.3019E+00_wp,1.3017E+00_wp,&
		                    1.3015E+00_wp,1.3014E+00_wp,1.3012E+00_wp,1.3010E+00_wp,&
		                    1.3009E+00_wp,1.3007E+00_wp,1.3005E+00_wp,1.3003E+00_wp,&
		                    1.3002E+00_wp,1.3000E+00_wp,1.2998E+00_wp,1.2997E+00_wp,&
		                    1.2995E+00_wp,1.2993E+00_wp,1.2991E+00_wp,1.2990E+00_wp,&
		                    1.2988E+00_wp,1.2986E+00_wp,1.2984E+00_wp,1.2982E+00_wp,&
		                    1.2980E+00_wp,1.2979E+00_wp,1.2977E+00_wp,1.2975E+00_wp,&
		                    1.2973E+00_wp,1.2971E+00_wp,1.2969E+00_wp,1.2967E+00_wp,&
		                    1.2965E+00_wp,1.2963E+00_wp,1.2961E+00_wp,1.2959E+00_wp,&
		                    1.2957E+00_wp,1.2955E+00_wp,1.2953E+00_wp,1.2951E+00_wp,&
		                    1.2949E+00_wp,1.2946E+00_wp,1.2944E+00_wp,1.2941E+00_wp,&
		                    1.2939E+00_wp,1.2937E+00_wp,1.2934E+00_wp,1.2931E+00_wp,&
		                    1.2929E+00_wp,1.2927E+00_wp,1.2924E+00_wp,1.2921E+00_wp,&
		                    1.2920E+00_wp,1.2918E+00_wp,1.2916E+00_wp,1.2914E+00_wp,&
		                    1.2912E+00_wp,1.2909E+00_wp,1.2903E+00_wp,1.2897E+00_wp,&
		                    1.2890E+00_wp,1.2879E+00_wp,1.2870E+00_wp,1.2863E+00_wp,&
		                    1.2853E+00_wp,1.2843E+00_wp,1.2828E+00_wp,1.2816E+00_wp,&
		                    1.2811E+00_wp,1.2807E+00_wp,1.2805E+00_wp,1.2802E+00_wp,&
		                    1.2797E+00_wp,1.2788E+00_wp,1.2780E+00_wp,1.2771E+00_wp,&
		                    1.2762E+00_wp,1.2756E+00_wp,1.2750E+00_wp,1.2744E+00_wp,&
		                    1.2736E+00_wp,1.2728E+00_wp,1.2718E+00_wp,1.2707E+00_wp,&
		                    1.2694E+00_wp,1.2677E+00_wp,1.2663E+00_wp,1.2648E+00_wp,&
		                    1.2633E+00_wp,1.2609E+00_wp,1.2591E+00_wp,1.2587E+00_wp,&
		                    1.2582E+00_wp,1.2573E+00_wp,1.2564E+00_wp,1.2545E+00_wp,&
		                    1.2525E+00_wp,1.2504E+00_wp,1.2482E+00_wp,1.2459E+00_wp,&
		                    1.2435E+00_wp,1.2409E+00_wp,1.2382E+00_wp,1.2337E+00_wp,&
		                    1.2270E+00_wp,1.2232E+00_wp,1.2169E+00_wp,1.2135E+00_wp,&
		                    1.2097E+00_wp,1.2071E+00_wp,1.2043E+00_wp,1.1983E+00_wp,&
		                    1.1776E+00_wp,1.1507E+00_wp,1.1083E+00_wp,1.0657E+00_wp,&
		                    1.0453E+00_wp,1.0236E+00_wp,1.0001E+00_wp,9.7470E-01_wp,&
		                    9.5630E-01_wp,9.5380E-01_wp,9.6780E-01_wp,9.8730E-01_wp,&
		                    1.0026E+00_wp,1.0180E+00_wp,1.0390E+00_wp,1.0722E+00_wp,&
		                    1.1259E+00_wp,1.2089E+00_wp,1.3215E+00_wp,1.4225E+00_wp,&
		                    1.4933E+00_wp,1.5478E+00_wp,1.5970E+00_wp,1.6336E+00_wp,&
		                    1.6477E+00_wp,1.6405E+00_wp,1.6248E+00_wp,1.6108E+00_wp,&
		                    1.5905E+00_wp,1.5714E+00_wp,1.5559E+00_wp,1.5396E+00_wp,&
		                    1.5241E+00_wp,1.5086E+00_wp,1.4949E+00_wp,1.4827E+00_wp,&
		                    1.4710E+00_wp,1.4604E+00_wp,1.4502E+00_wp,1.4411E+00_wp,&
		                    1.4328E+00_wp,1.4146E+00_wp,1.3924E+00_wp,1.3850E+00_wp,&
		                    1.3750E+00_wp,1.3623E+00_wp,1.3526E+00_wp,1.3447E+00_wp,&
		                    1.3406E+00_wp,1.3401E+00_wp,1.3412E+00_wp,1.3444E+00_wp,&
		                    1.3473E+00_wp,1.3482E+00_wp,1.3491E+00_wp,1.3470E+00_wp,&
		                    1.3379E+00_wp,1.3325E+00_wp,1.3268E+00_wp,1.3212E+00_wp,&
		                    1.3176E+00_wp,1.3100E+00_wp,1.3013E+00_wp,1.2933E+00_wp,&
		                    1.2917E+00_wp,1.2906E+00_wp,1.2902E+00_wp,1.2904E+00_wp,&
		                    1.2915E+00_wp,1.3015E+00_wp,1.3083E+00_wp,1.3152E+00_wp,&
		                    1.3167E+00_wp,1.3178E+00_wp,1.3187E+00_wp,1.3194E+00_wp,&
		                    1.3201E+00_wp,1.3207E+00_wp,1.3214E+00_wp,1.3219E+00_wp,&
		                    1.3229E+00_wp,1.3242E+00_wp,1.3244E+00_wp,1.3236E+00_wp,&
		                    1.3229E+00_wp,1.3218E+00_wp,1.3200E+00_wp,1.3183E+00_wp,&
		                    1.3158E+00_wp,1.3123E+00_wp,1.3086E+00_wp,1.3047E+00_wp,&
		                    1.3007E+00_wp,1.2964E+00_wp,1.2917E+00_wp,1.2835E+00_wp,&
		                    1.2735E+00_wp,1.2655E+00_wp,1.2561E+00_wp,1.2387E+00_wp,&
		                    1.2151E+00_wp,1.1926E+00_wp,1.1659E+00_wp,1.1501E+00_wp,&
		                    1.1323E+00_wp,1.1136E+00_wp,1.0971E+00_wp,1.0867E+00_wp,&
		                    1.0833E+00_wp,1.0886E+00_wp,1.1023E+00_wp,1.1439E+00_wp,&
		                    1.1983E+00_wp,1.2546E+00_wp,1.3194E+00_wp,1.3822E+00_wp,&
		                    1.4412E+00_wp,1.4683E+00_wp,1.4928E+00_wp,1.5132E+00_wp,&
		                    1.5300E+00_wp,1.5458E+00_wp,1.5596E+00_wp,1.5701E+00_wp,&
		                    1.5775E+00_wp,1.5762E+00_wp,1.5637E+00_wp,1.5559E+00_wp,&
		                    1.5481E+00_wp,1.5353E+00_wp,1.5302E+00_wp,1.5294E+00_wp,&
		                    1.5306E+00_wp,1.5303E+00_wp,1.5141E+00_wp,1.5104E+00_wp,&
		                    1.5043E+00_wp,1.4982E+00_wp,1.4939E+00_wp,1.4963E+00_wp,&
		                    1.4986E+00_wp,1.4956E+00_wp,1.4877E+00_wp,1.4575E+00_wp,&
		                    1.4486E+00_wp,1.4390E+00_wp,1.4282E+00_wp,1.4102E+00_wp,&
		                    1.4030E+00_wp,1.3854E+00_wp,1.3404E+00_wp,1.2969E+00_wp,&
		                    1.2641E+00_wp,1.2530E+00_wp,1.2445E+00_wp,1.2371E+00_wp,&
		                    1.2317E+00_wp,1.2243E+00_wp,1.2054E+00_wp,1.1742E+00_wp,&
		                    1.1549E+00_wp,1.1496E+00_wp,1.1853E+00_wp,1.2543E+00_wp,&
		                    1.3474E+00_wp,1.4725E+00_wp,1.5874E+00_wp,1.6841E+00_wp,&
		                    1.7505E+00_wp,1.7649E+00_wp,1.7668E+00_wp,1.7687E+00_wp,&
		                    1.7792E+00_wp,1.7955E+00_wp,1.8052E+00_wp,1.8041E+00_wp,&
		                    1.7940E+00_wp,1.7805E+00_wp,1.7410E+00_wp,1.6930E+00_wp,&
		                    1.6610E+00_wp,1.6419E+00_wp,1.6396E+00_wp,1.6372E+00_wp,&
		                    1.6471E+00_wp,1.6596E+00_wp,1.6754E+00_wp,1.6945E+00_wp,&
		                    1.7167E+00_wp,1.7466E+00_wp,1.7780E+00_wp,1.8185E+00_wp,&
		                    1.8419E+00_wp,1.8504E+00_wp,1.8617E+00_wp,1.8669E+00_wp,&
		                    1.8688E+00_wp,1.8699E+00_wp,1.8698E+00_wp,1.8681E+00_wp,&
		                    1.8654E+00_wp,1.8499E+00_wp,1.8268E+00_wp,1.8114E+00_wp,&
		                    1.7989E+00_wp,1.7908E+00_wp,1.7868E+00_wp,1.7861E+00_wp,&
		                    1.7861E+00_wp,1.7861E+00_wp,1.7861E+00_wp,1.7861E+00_wp,&
		                    1.7861E+00_wp,1.7861E+00_wp,1.7861E+00_wp,1.7861E+00_wp,&
		                    1.7861E+00_wp,1.7861E+00_wp,1.7861E+00_wp,1.7861E+00_wp]					   

        real(wp), dimension(n_rfri) :: ni_h2oi=[1.6400E-01_wp,1.7300E-01_wp,&
		                    1.8300E-01_wp,1.9500E-01_wp,2.0800E-01_wp,2.2300E-01_wp,&
		                    2.4000E-01_wp,2.5000E-01_wp,2.5900E-01_wp,2.6800E-01_wp,&
		                    2.7900E-01_wp,2.9700E-01_wp,3.1900E-01_wp,3.4000E-01_wp,&
		                    3.6600E-01_wp,3.9200E-01_wp,4.1600E-01_wp,4.4000E-01_wp,&
		                    4.6400E-01_wp,4.9200E-01_wp,5.1700E-01_wp,5.2800E-01_wp,&
		                    5.3300E-01_wp,5.3400E-01_wp,5.3100E-01_wp,5.2400E-01_wp,&
		                    5.1000E-01_wp,5.0000E-01_wp,4.9900E-01_wp,4.6800E-01_wp,&
		                    3.8000E-01_wp,3.6000E-01_wp,3.3900E-01_wp,3.1800E-01_wp,&
		                    2.9100E-01_wp,2.5100E-01_wp,2.4400E-01_wp,2.3900E-01_wp,&
		                    2.3900E-01_wp,2.4400E-01_wp,2.4700E-01_wp,2.2400E-01_wp,&
		                    1.9500E-01_wp,1.7400E-01_wp,1.7200E-01_wp,1.8000E-01_wp,&
		                    1.9400E-01_wp,2.1300E-01_wp,2.4300E-01_wp,2.7100E-01_wp,&
		                    2.8900E-01_wp,3.3400E-01_wp,3.4400E-01_wp,3.8200E-01_wp,&
		                    4.0100E-01_wp,4.0650E-01_wp,4.0500E-01_wp,3.8900E-01_wp,&
		                    3.7700E-01_wp,3.4500E-01_wp,3.3200E-01_wp,3.1500E-01_wp,&
		                    2.9800E-01_wp,2.7400E-01_wp,2.2800E-01_wp,1.9800E-01_wp,&
		                    1.7200E-01_wp,1.5600E-01_wp,1.1000E-01_wp,8.3000E-02_wp,&
		                    5.8000E-02_wp,2.2000E-02_wp,8.4730E-03_wp,3.2630E-03_wp,&
		                    1.2560E-03_wp,4.8370E-04_wp,1.8620E-04_wp,7.1650E-05_wp,&
		                    2.7570E-05_wp,1.0610E-05_wp,4.0810E-06_wp,1.5700E-06_wp,&
		                    5.4030E-07_wp,1.8290E-07_wp,6.2180E-08_wp,2.1130E-08_wp,&
		                    7.1810E-09_wp,2.4400E-09_wp,8.2890E-10_wp,2.8160E-10_wp,&
		                    9.5650E-11_wp,3.2490E-11_wp,2.0000E-11_wp,2.0000E-11_wp,&
		                    2.0000E-11_wp,2.0000E-11_wp,2.0000E-11_wp,2.0000E-11_wp,&
		                    2.3650E-11_wp,2.6690E-11_wp,3.1350E-11_wp,4.1400E-11_wp,&
		                    6.2680E-11_wp,9.2390E-11_wp,1.3250E-10_wp,1.9560E-10_wp,&
		                    2.8610E-10_wp,4.1720E-10_wp,5.8890E-10_wp,8.0360E-10_wp,&
		                    1.0760E-09_wp,1.4090E-09_wp,1.8130E-09_wp,2.2890E-09_wp,&
		                    2.8390E-09_wp,3.4610E-09_wp,4.1590E-09_wp,4.9300E-09_wp,&
		                    5.7300E-09_wp,6.8900E-09_wp,8.5800E-09_wp,1.0400E-08_wp,&
		                    1.2200E-08_wp,1.4300E-08_wp,1.6600E-08_wp,1.8900E-08_wp,&
		                    2.0900E-08_wp,2.4000E-08_wp,2.9000E-08_wp,3.4400E-08_wp,&
		                    4.0300E-08_wp,4.3000E-08_wp,4.9200E-08_wp,5.8700E-08_wp,&
		                    7.0800E-08_wp,8.5800E-08_wp,1.0200E-07_wp,1.1800E-07_wp,&
		                    1.3400E-07_wp,1.4000E-07_wp,1.4300E-07_wp,1.4500E-07_wp,&
		                    1.5100E-07_wp,1.8300E-07_wp,2.1500E-07_wp,2.6500E-07_wp,&
		                    3.3500E-07_wp,3.9200E-07_wp,4.2000E-07_wp,4.4400E-07_wp,&
		                    4.7400E-07_wp,5.1100E-07_wp,5.5300E-07_wp,6.0200E-07_wp,&
		                    7.5500E-07_wp,9.2600E-07_wp,1.1200E-06_wp,1.3300E-06_wp,&
		                    1.6200E-06_wp,2.0000E-06_wp,2.2500E-06_wp,2.3300E-06_wp,&
		                    2.3300E-06_wp,2.1700E-06_wp,1.9600E-06_wp,1.8100E-06_wp,&
		                    1.7400E-06_wp,1.7300E-06_wp,1.7000E-06_wp,1.7600E-06_wp,&
		                    1.8200E-06_wp,2.0400E-06_wp,2.2500E-06_wp,2.2900E-06_wp,&
		                    3.0400E-06_wp,3.8400E-06_wp,4.7700E-06_wp,5.7600E-06_wp,&
		                    6.7100E-06_wp,8.6600E-06_wp,1.0200E-05_wp,1.1300E-05_wp,&
		                    1.2200E-05_wp,1.2900E-05_wp,1.3200E-05_wp,1.3500E-05_wp,&
		                    1.3300E-05_wp,1.3200E-05_wp,1.3200E-05_wp,1.3100E-05_wp,&
		                    1.3200E-05_wp,1.3200E-05_wp,1.3400E-05_wp,1.3900E-05_wp,&
		                    1.4200E-05_wp,1.4800E-05_wp,1.5800E-05_wp,1.7400E-05_wp,&
		                    1.9800E-05_wp,3.4420E-05_wp,5.9590E-05_wp,1.0280E-04_wp,&
		                    1.5160E-04_wp,2.0300E-04_wp,2.9420E-04_wp,3.9870E-04_wp,&
		                    4.9410E-04_wp,5.5320E-04_wp,5.3730E-04_wp,5.1430E-04_wp,&
		                    4.9080E-04_wp,4.5940E-04_wp,3.8580E-04_wp,3.1050E-04_wp,&
		                    2.6590E-04_wp,2.3610E-04_wp,2.0460E-04_wp,1.8750E-04_wp,&
		                    1.6500E-04_wp,1.5220E-04_wp,1.4110E-04_wp,1.3020E-04_wp,&
		                    1.3100E-04_wp,1.3390E-04_wp,1.3770E-04_wp,1.4320E-04_wp,&
		                    1.6320E-04_wp,2.5660E-04_wp,4.0810E-04_wp,7.0600E-04_wp,&
		                    1.1080E-03_wp,1.4420E-03_wp,1.6140E-03_wp,1.6400E-03_wp,&
		                    1.5660E-03_wp,1.4580E-03_wp,1.2670E-03_wp,1.0230E-03_wp,&
		                    7.5860E-04_wp,5.2550E-04_wp,4.0250E-04_wp,3.2350E-04_wp,&
		                    2.7070E-04_wp,2.2280E-04_wp,2.0370E-04_wp,2.0260E-04_wp,&
		                    2.0350E-04_wp,2.0780E-04_wp,2.1710E-04_wp,2.5380E-04_wp,&
		                    3.1380E-04_wp,3.8580E-04_wp,4.5910E-04_wp,5.1870E-04_wp,&
		                    5.6050E-04_wp,5.9560E-04_wp,6.2590E-04_wp,6.8200E-04_wp,&
		                    7.5300E-04_wp,7.6850E-04_wp,7.6470E-04_wp,7.4730E-04_wp,&
		                    7.3920E-04_wp,7.4370E-04_wp,7.5430E-04_wp,8.0590E-04_wp,&
		                    1.3670E-03_wp,3.5080E-03_wp,1.3460E-02_wp,3.2450E-02_wp,&
		                    4.5720E-02_wp,6.2870E-02_wp,8.5480E-02_wp,1.1980E-01_wp,&
		                    1.6900E-01_wp,2.2100E-01_wp,2.7600E-01_wp,3.1200E-01_wp,&
		                    3.4700E-01_wp,3.8800E-01_wp,4.3800E-01_wp,4.9300E-01_wp,&
		                    5.5400E-01_wp,6.1200E-01_wp,6.2500E-01_wp,5.9300E-01_wp,&
		                    5.3900E-01_wp,4.9100E-01_wp,4.3800E-01_wp,3.7200E-01_wp,&
		                    3.0000E-01_wp,2.3800E-01_wp,1.9300E-01_wp,1.5800E-01_wp,&
		                    1.2100E-01_wp,1.0300E-01_wp,8.3600E-02_wp,6.6800E-02_wp,&
		                    5.3120E-02_wp,4.2860E-02_wp,3.5230E-02_wp,2.8870E-02_wp,&
		                    2.3470E-02_wp,1.9210E-02_wp,1.5860E-02_wp,1.3260E-02_wp,&
		                    1.1300E-02_wp,8.1460E-03_wp,6.6720E-03_wp,6.9660E-03_wp,&
		                    8.2480E-03_wp,1.1120E-02_wp,1.4710E-02_wp,1.8670E-02_wp,&
		                    2.4110E-02_wp,2.6560E-02_wp,2.9900E-02_wp,3.1790E-02_wp,&
		                    3.0900E-02_wp,3.0070E-02_wp,2.8830E-02_wp,1.9400E-02_wp,&
		                    1.3470E-02_wp,1.2400E-02_wp,1.2200E-02_wp,1.3020E-02_wp,&
		                    1.3800E-02_wp,1.6830E-02_wp,2.2320E-02_wp,3.2560E-02_wp,&
		                    3.5390E-02_wp,3.8830E-02_wp,4.2700E-02_wp,4.6430E-02_wp,&
		                    5.0450E-02_wp,6.4390E-02_wp,6.5600E-02_wp,6.3600E-02_wp,&
		                    6.2650E-02_wp,6.1700E-02_wp,6.1010E-02_wp,6.0310E-02_wp,&
		                    5.9640E-02_wp,5.8990E-02_wp,5.7800E-02_wp,5.7000E-02_wp,&
		                    5.6800E-02_wp,5.4280E-02_wp,5.1610E-02_wp,4.9400E-02_wp,&
		                    4.8400E-02_wp,4.6000E-02_wp,4.4400E-02_wp,4.2900E-02_wp,&
		                    4.0410E-02_wp,3.9110E-02_wp,3.8190E-02_wp,3.7600E-02_wp,&
		                    3.7240E-02_wp,3.7000E-02_wp,3.6770E-02_wp,3.6540E-02_wp,&
		                    3.6640E-02_wp,3.7060E-02_wp,3.7890E-02_wp,4.0260E-02_wp,&
		                    4.4500E-02_wp,5.0080E-02_wp,6.4610E-02_wp,7.5000E-02_wp,&
		                    8.8000E-02_wp,1.0800E-01_wp,1.3400E-01_wp,1.6800E-01_wp,&
		                    2.0400E-01_wp,2.4800E-01_wp,2.8000E-01_wp,3.4100E-01_wp,&
		                    3.7900E-01_wp,4.0900E-01_wp,4.2200E-01_wp,4.2200E-01_wp,&
		                    4.0300E-01_wp,3.8900E-01_wp,3.7400E-01_wp,3.5400E-01_wp,&
		                    3.3500E-01_wp,3.1500E-01_wp,2.9400E-01_wp,2.7100E-01_wp,&
		                    2.4600E-01_wp,1.9800E-01_wp,1.6400E-01_wp,1.5200E-01_wp,&
		                    1.4200E-01_wp,1.2800E-01_wp,1.2500E-01_wp,1.2300E-01_wp,&
		                    1.1600E-01_wp,1.0700E-01_wp,7.9000E-02_wp,7.7520E-02_wp,&
		                    7.4550E-02_wp,7.2000E-02_wp,7.6000E-02_wp,7.5000E-02_wp,&
		                    6.7000E-02_wp,5.5000E-02_wp,4.5000E-02_wp,2.9000E-02_wp,&
		                    2.7500E-02_wp,2.7000E-02_wp,2.7300E-02_wp,2.8900E-02_wp,&
		                    3.0000E-02_wp,3.4000E-02_wp,5.1220E-02_wp,8.6150E-02_wp,&
		                    1.3480E-01_wp,1.6150E-01_wp,1.8950E-01_wp,2.2270E-01_wp,&
		                    2.5280E-01_wp,2.8530E-01_wp,3.2400E-01_wp,3.9450E-01_wp,&
		                    4.5210E-01_wp,5.5350E-01_wp,6.7820E-01_wp,7.6840E-01_wp,&
		                    8.2540E-01_wp,8.4580E-01_wp,8.1580E-01_wp,7.4140E-01_wp,&
		                    6.1910E-01_wp,5.3530E-01_wp,4.7800E-01_wp,4.5990E-01_wp,&
		                    4.4680E-01_wp,4.2140E-01_wp,3.8600E-01_wp,3.5080E-01_wp,&
		                    3.1960E-01_wp,2.9810E-01_wp,2.6590E-01_wp,2.5690E-01_wp,&
		                    2.7850E-01_wp,3.0760E-01_wp,3.1460E-01_wp,3.4710E-01_wp,&
		                    3.7480E-01_wp,3.9020E-01_wp,4.0240E-01_wp,4.1150E-01_wp,&
		                    4.1670E-01_wp,4.1670E-01_wp,4.0890E-01_wp,3.8300E-01_wp,&
		                    3.5430E-01_wp,3.3400E-01_wp,2.9440E-01_wp,2.6790E-01_wp,&
		                    2.5190E-01_wp,2.3900E-01_wp,2.1400E-01_wp,1.9130E-01_wp,&
		                    1.7060E-01_wp,1.1510E-01_wp,6.6840E-02_wp,4.2820E-02_wp,&
		                    2.5490E-02_wp,1.4050E-02_wp,5.1730E-03_wp,1.3370E-03_wp,&
		                    3.5740E-04_wp,1.8390E-04_wp,1.2940E-04_wp,1.0580E-04_wp,&
		                    9.6750E-05_wp,9.3600E-05_wp,9.6130E-05_wp,1.0660E-04_wp,&
		                    1.3120E-04_wp,1.8950E-04_wp,3.3480E-04_wp,6.5960E-04_wp]
	
		                    
		private
		public :: e_photon, plancks_law, real_refractive_air, refractive_h2o, &
		            real_refractive_h2o, imag_refractive_h2o, &
		            solve_fluxes, solar_zenith, &
					nm2, radg1,allocate_and_set_radiation

		contains
		
		
		
		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		!>@author
		!>Paul J. Connolly, The University of Manchester
		!>@brief
		!>initialise variables for radiation
		!>@param[in] lambda
		!>@param[inout] b_s_g_lambda: the scattering cross section
		subroutine allocate_and_set_radiation(start_year, start_mon, &
		  				 				start_day, start_hour,start_min, start_sec, &
		  				 				gases_file, &
		  				 				probs_read, lambda_low_read, lambda_high_read, &
		  				 				h2o_read, press_read, temp_read, bli_read, &
		  				 				molecularWeights_read, &
		  				 				nh2o, npress, ntemp, nweights, nmolecule, nbands, &
		  				 				itemp, ipress, &
		  									ip,jp,kp,ns,nl,ns_r,nl_r, &
											ntot, &
		  									albedo_r,emiss_r, alb, emiss, &
		  									lat_ref,lon_ref, lat, lon, &
		  									nmolecule_nm, moleculeID_nm, &
											lambda_read_s,lambda_read_l, &
											lambda_s_low, lambda_s_high, &
											lambda_l_low, lambda_l_high, &
											lambda,lambda_low,lambda_high, delta_lambda,&
											nrwbin,niwbin, &
											sflux_l, b_s_g, &
											ext_s_g, flux_u, flux_d, rad_power, &
											l_h, r_h, rhoan, thetan, trefn, &
											nprocv,mvrecv, &
											tdstart,tdend,a,b,c,r,u, &
											coords,dims, id, comm3d)
			use mpi
			use netcdf
			implicit none
			character (len=200), intent(in) :: albedo_r, emiss_r
			character (len=200), intent(in) :: gases_file
			real(wp), intent(inout), dimension(:), allocatable :: probs_read, &
			            lambda_low_read, lambda_high_read, h2o_read, press_read, &
			            temp_read, molecularWeights_read
			integer(i4b), intent(inout) :: nh2o, npress, ntemp, nweights, &
			                                nmolecule, nbands
			integer(i4b), intent(inout), dimension(:), allocatable :: itemp, ipress
			real(wp), intent(inout), dimension(:,:,:,:,:,:), allocatable :: bli_read
			real(wp), intent(inout) :: alb, emiss
			real(wp), intent(in) :: lat_ref, lon_ref
			real(wp), intent(inout) :: lat, lon
			integer(i4b), intent(in) :: nmolecule_nm
			integer(i4b), intent(in), dimension(nmolecule_nm) :: moleculeID_nm
			integer(i4b), intent(in) :: start_year, start_mon, start_day, start_hour, &
									start_min, start_sec
			integer(i4b), intent(in) :: ns_r,nl_r, l_h, r_h
			integer(i4b), intent(inout) :: ip, jp, kp, ns,nl, ntot
			real(wp), intent(in), dimension(:) :: lambda_read_s, lambda_read_l
			real(wp), intent(in) :: lambda_s_low, lambda_s_high, &
									lambda_l_low, lambda_l_high
			real(wp), intent(inout), dimension(:), allocatable :: lambda, &
						lambda_low, lambda_high, delta_lambda, b_s_g, ext_s_g, sflux_l, &
						nrwbin,niwbin
			real(wp), intent(in), dimension(1-l_h:kp+r_h) :: rhoan, thetan, trefn
			real(wp), dimension(:,:,:,:), allocatable, intent(inout) :: flux_d,flux_u
			real(wp), dimension(:,:,:), allocatable, intent(inout) :: rad_power
			integer(i4b), intent(inout) :: nprocv,tdstart,tdend
			real(wp), dimension(:), allocatable, intent(inout) :: mvrecv,a,b,c,r,u
			integer(i4b), dimension(3), intent(inout) :: coords
			integer(i4b), dimension(3), intent(in) :: dims
			integer(i4b), intent(in) :: id, comm3d
			
			integer(i4b), dimension(:), allocatable :: moleculeID_read
			real(wp) :: sum_upper, sum_lower, x_upper, x_lower, fac
		    character(len = 100) :: str 
			integer(i4b) :: AllocateStatus, i, j,doy, error, &
			                ncid, varid, dimid
			logical :: leap
			
! if the pe is not being used in the cartesian topology, do not use here
			if(id>=dims(1)*dims(2)*dims(3)) return 
		
				
		    ! find out how many procs in this communicator
		    call MPI_Comm_size(comm3d, nprocv,error)
            
            
            !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
            ! array bounds for tridag solver                                             !
            !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
            tdend=kp*2
            if(coords(3)==0) then 
                ! bottom level: 1 is for lower BC
                tdstart=2
                tdend=tdend+1
            else 
                tdstart=1
            endif
            
            if(coords(3)==(dims(3)-1)) then
                tdend=tdend+1
            endif
            !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
            

			! some calcs
			! set the lat / lon
			lat=lat_ref
			lon=lon_ref
			! find the surface emissivity
			do i=1,nemiss
				if(emiss_r == trim(rsv%emiss_des(i))) then
					exit
				endif
			enddo
			emiss=rsv%emiss(i)
			
			! find the surface albedo
			do i=1,nalb
				if(albedo_r == trim(rsv%albedo_des(i))) then
					exit
				endif
			enddo
			alb=rsv%albedo(i)
			
			
			
			! calculate days in year:
			call leap_year_calc(start_year,diy_s,leap)
			call doy_calc(start_year,start_mon,start_day,diy_s,doy_s, leap)
			
			! number of wave bands for radiation:
			nl=nl_r
			ns=ns_r
			ntot=ns+nl
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			! allocate memory
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			allocate( a(1:tdend), STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			allocate( b(1:tdend), STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			allocate( c(1:tdend), STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			allocate( r(1:tdend), STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			allocate( u(1:tdend), STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			allocate( mvrecv(1:nprocv), STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"

			allocate( lambda(1:ntot), STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			allocate( lambda_low(1:ntot), STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			allocate( lambda_high(1:ntot), STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			allocate( delta_lambda(1:ntot), STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			allocate( sflux_l(1:ntot), STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			allocate( b_s_g(1:ntot), STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			allocate( nrwbin(1:ntot), STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			allocate( niwbin(1:ntot), STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			allocate( ext_s_g(1:kp), STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			allocate( flux_d(1-r_h:kp+r_h,1-r_h:jp+r_h,1-r_h:ip+r_h,1:ntot), &
									STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			allocate( flux_u(1-r_h:kp+r_h,1-r_h:jp+r_h,1-r_h:ip+r_h,1:ntot), &
									STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			allocate( rad_power(1-r_h:kp+r_h,1-r_h:jp+r_h,1-r_h:ip+r_h), &
									STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			
			
			! for the netCDF variables
            call check(nf90_open(gases_file, NF90_NOWRITE, ncid))	
            call check( nf90_inq_dimid(ncid, "nh2o", dimid))
            call check( nf90_inquire_dimension(ncid, dimid, str,nh2o))
            call check( nf90_inq_dimid(ncid, "npress", dimid))
            call check( nf90_inquire_dimension(ncid, dimid, str,npress))
            call check( nf90_inq_dimid(ncid, "ntemp", dimid))
            call check( nf90_inquire_dimension(ncid, dimid, str,ntemp))
            call check( nf90_inq_dimid(ncid, "weights", dimid))
            call check( nf90_inquire_dimension(ncid, dimid, str,nweights))
            call check( nf90_inq_dimid(ncid, "molecule", dimid))
            call check( nf90_inquire_dimension(ncid, dimid, str,nmolecule))
            call check( nf90_inq_dimid(ncid, "nbands", dimid))
            call check( nf90_inquire_dimension(ncid, dimid, str,nbands))
            ! allocation
			allocate( h2o_read(1:nh2o),STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			allocate( press_read(1:npress),STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			allocate( temp_read(1:ntemp),STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			allocate( probs_read(1:nweights),STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			allocate( lambda_low_read(1:nbands),STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			allocate( lambda_high_read(1:nbands),STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			allocate( bli_read(1:nbands,1:nmolecule,1:nweights, &
			        1:ntemp,1:npress, 1:nh2o),STAT = AllocateStatus)
			allocate( moleculeID_read(1:nmolecule),STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			allocate( molecularWeights_read(1:nmolecule),STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			allocate( itemp(1-r_h:kp+r_h),STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			allocate( ipress(1-r_h:kp+r_h),STAT = AllocateStatus)
			if (AllocateStatus /= 0) STOP "*** Not enough memory ***"
			
            
            ! read variables
            call check( nf90_inq_varid(ncid, "bli", varid))
            call check( nf90_get_var(ncid, varid, bli_read))
        
            call check( nf90_inq_varid(ncid, "probs", varid))
            call check( nf90_get_var(ncid, varid, probs_read))
        
            call check( nf90_inq_varid(ncid, "lambda_low", varid))
            call check( nf90_get_var(ncid, varid, lambda_low_read))

            call check( nf90_inq_varid(ncid, "lambda_high", varid))
            call check( nf90_get_var(ncid, varid, lambda_high_read))
        
            call check( nf90_inq_varid(ncid, "h2o", varid))
            call check( nf90_get_var(ncid, varid, h2o_read))

            call check( nf90_inq_varid(ncid, "press", varid))
            call check( nf90_get_var(ncid, varid, press_read))

            call check( nf90_inq_varid(ncid, "temp", varid))
            call check( nf90_get_var(ncid, varid, temp_read))

            call check( nf90_inq_varid(ncid, "moleculeID", varid))
            call check( nf90_get_var(ncid, varid, moleculeID_read))

            call check( nf90_inq_varid(ncid, "molecularWeights", varid))
            call check( nf90_get_var(ncid, varid, molecularWeights_read))

            call check( nf90_close(ncid) )		
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			
			
			

			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			! bands that we are solving for radiative transfer in:						 !
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			! short wave:
			if (ns > 0) then
				lambda(1:ns)=lambda_read_s(1:ns)
				lambda_low(1)=lambda_s_low
				lambda_low(2:ns)=(lambda(2:ns)+lambda(1:ns-1)) / 2._wp
				lambda_high(ns)=lambda_s_high
				lambda_high(1:ns-1)=(lambda(2:ns)+lambda(1:ns-1)) / 2._wp
				delta_lambda(1:ns) = lambda_high(1:ns)-lambda_low(1:ns)
			endif
			! long wave:
			if (nl > 0) then
				lambda(ns+1:ntot)=lambda_read_l(1:nl)
				lambda_low(ns+1)=lambda_l_low
				lambda_low(ns+2:ntot)=(lambda(ns+2:ntot)+lambda(ns+1:ntot-1)) / 2._wp
				lambda_high(ntot)=lambda_l_high
				lambda_high(ns+1:ntot-1)=(lambda(ns+2:ntot)+lambda(ns+1:ntot-1)) / 2._wp
				delta_lambda(ns+1:ntot) = lambda_high(ns+1:ntot)-lambda_low(ns+1:ntot)
			endif
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			! perform check on band definitions:						                 !
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
            do i=1,nbands
                if((abs(lambda_low_read(i)-lambda_low(i))/lambda_low(i) > 1.e-3 ).or. &
                    (abs(lambda_high_read(i)-lambda_high(i))/lambda_high(i) > 1.e-3 )) then
                    print *,"recalculate absorption coefficients", &
                        lambda_high_read(i), lambda_high(i), i
                    stop
                endif
            enddo
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			! perform check on moleculeIDs      						                 !
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
            if(nmolecule_nm.ne.nmolecule) then
                print *,'moleculeID not correct'
                stop
            endif
            do i=1,nmolecule_nm
                if(moleculeID_read(i).ne.moleculeID_nm(i)) then
                    print *,'moleculeID not correct', moleculeID_read(i), moleculeID_nm(i)
                    stop
                endif
            enddo
            deallocate(moleculeID_read)
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!




			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			! define pointer for temperature and pressure:						         !
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
            do i=1-r_h,kp+r_h
                itemp(i)=find_pos(temp_read(1:ntemp),trefn(i))
                itemp(i)=min(ntemp,itemp(i))
                itemp(i)=max(1,itemp(i))
            enddo
            do i=1-r_h,kp+r_h
                ipress(i)=find_pos(press_read(1:npress),rhoan(i)*ra*trefn(i))
                ipress(i)=min(npress,ipress(i))
                ipress(i)=max(1,ipress(i))
            enddo
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

			
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			! calculate the planck function in these bins, and scale to TOA				 !
			! see http://www.spectralcalc.com/blackbody/inband_radiance.html             !
			! note, the integral result is the same no matter form of BB function        !
			! but the value of x is what is in the exponential                           !
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			fac=fac_planck / sigma_sb * sflux
			do i=1,ntot
				x_upper=h_planck*c_light/(k_boltz*temp_sun*lambda_high(i))
				x_lower=h_planck*c_light/(k_boltz*temp_sun*lambda_low(i))
				sum_upper=0._wp
				do j=1,min(512 , 2+nint(20._wp/x_upper)) ! criteria on webpage
					sum_upper=sum_upper+(x_upper**3./real(j,wp) + &
							3._wp*x_upper**2./real(j,wp)**2 + &
							6._wp*x_upper/real(j,wp)**3 + &
							6._wp/real(j,wp)**4) * &
								exp(-real(j,wp)*x_upper)
				enddo
				
				sum_lower=0._wp
				do j=1,min(512 , 2+nint(20._wp/x_lower)) ! criteria on webpage
					sum_lower=sum_lower+(x_lower**3./real(j,wp) + &
							3._wp*x_lower**2./real(j,wp)**2 + &
							6._wp*x_lower/real(j,wp)**3 + &
							6._wp/real(j,wp)**4) * &
								exp(-real(j,wp)*x_lower)
				enddo
				sflux_l(i) = fac*(sum_upper-sum_lower)
			enddo
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


			! calculate scattering cross section due to rayleigh:
			do i=1,ntot
				call scattering_cs_rayleigh(lambda(i),b_s_g(i))
			enddo
	
			! now:
			! 3. asymmetry parameters, for aerosol, and hydrometeors - read
			! 4. scattering cross sections for aerosol, absorption cross sections?
			! 5. Tyndall, Mie, Geometric
			do i=1,ntot
			    ! calculate the bin averaged real refractive index 
			    nrwbin(i)=romb(real_refractive_h2o,lambda_low(i),lambda_high(i)) / &
			                (lambda_high(i)-lambda_low(i))
			    ! calculate the bin averaged imaginary refractive index 
			    niwbin(i)=romb(imag_refractive_h2o,lambda_low(i),lambda_high(i)) / &
			                (lambda_high(i)-lambda_low(i))
			                
! 			    nrwbin(i:i)=real_refractive_h2o((lambda_low(i)+lambda_high(i:i))*0.5_wp)
! 			    niwbin(i:i)=imag_refractive_h2o((lambda_low(i)+lambda_high(i:i))*0.5_wp)
			enddo

			! 6. Optical depth

        contains
          subroutine check(status)
            integer, intent ( in) :: status
    
            if(status /= nf90_noerr) then 
              print *, trim(nf90_strerror(status))
              stop "Stopped"
            end if
          end subroutine check     
		end subroutine allocate_and_set_radiation
		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!







		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		!>@author
		!>Paul J. Connolly, The University of Manchester
		!>@brief
		!>calculate energy in a photon of wavelength lambda
		!>@param[in] lambda
		function e_photon(lambda)
			implicit none
			real(wp), intent(in) :: lambda
			real(wp) :: e_photon
		
			e_photon=h_planck*c_light / lambda
	
		end function e_photon
		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!







		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		!>@author
		!>Paul J. Connolly, The University of Manchester
		!>@brief
		!>calculate scattering cross section due to Rayleigh scattering
		!>@param[in] lambda
		!>@param[inout] b_s_g_lambda: the scattering cross section
		subroutine scattering_cs_rayleigh(lambda,b_s_g_lambda)
			implicit none
			real(wp), intent(in) :: lambda
			real(wp), intent(inout) :: b_s_g_lambda
			real(wp) :: n_a_l, delta, f_delta
		
			delta = 0.0279_wp ! Young (1980)
			! anisotropic correction term (in equation 9.36):
			f_delta = (6._wp+3._wp*delta) / (6._wp-7._wp*delta)
			
			
			call real_refractive_air(lambda,n_a_l)

			! scattering cross section due to Rayleigh scattering
			b_s_g_lambda=8._wp*pi**3._wp*(n_a_l**2._wp -1._wp)**2._wp &
						/ (3._wp*lambda**4._wp * N_a_0**2._wp) &
						* f_delta
		end subroutine scattering_cs_rayleigh
		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!







		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		!>@author
		!>Paul J. Connolly, The University of Manchester
		!>@brief
		!>radiant intensity, or radiance from Planck's law
		!>@param[in] lambda, T
		!>@param[inout] b_lambda_t
		subroutine plancks_law(lambda,t,b_lambda_t)
			implicit none
			real(wp), intent(in) :: lambda,t
			real(wp), intent(inout) :: b_lambda_t
		
			b_lambda_t = 2._wp*h_planck*c_light**2 / (lambda**5 * &
						(exp(h_planck*c_light/(lambda*k_boltz*T))-1._wp) )
	
		end subroutine plancks_law
		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!




		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		!>@author
		!>Paul J. Connolly, The University of Manchester
		!>@brief
		!>real refractive index in air vs wavelength
		!>Edlen (1966)
		!>@param[in] lambda
		!>@param[inout] na
		subroutine real_refractive_air(lambda,na)
			implicit none
			real(wp), intent(in) :: lambda
			real(wp), intent(inout) :: na
			
			real(wp) :: lambda_mu
			
			lambda_mu = lambda*1.e6_wp
		
			! Edlen, 1966:
! 			na=1._wp+1e-8_wp*( 8342.13_wp+(2406030._wp/(130._wp-lambda_mu**(-2))) + &
! 						(15997._wp/(38.9_wp-lambda_mu**(-2)))	)
			! Peck and Reeder, 1972:
			na=1._wp+1.e-8_wp*( 8060.51_wp+(2480990._wp/(132.274_wp-lambda_mu**(-2))) + &
						(17455.7_wp/(39.32957_wp-lambda_mu**(-2)))	)
	
		end subroutine real_refractive_air
		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		!>@author
		!>Paul J. Connolly, The University of Manchester
		!>@brief
		!>real and imaginary refractive index of water vs wavelength
		!>just a lookup table from 
		!>https://en.wikipedia.org/wiki/Optical_properties_of_water_and_ice#Refractive_Index,_Real_and_Imaginary_Parts_for_Liquid_Water
		!>@param[in] lambda
		!>@param[inout] nr, ni
		subroutine refractive_h2o(lambda,nr,ni)
			implicit none
			real(wp), intent(in) :: lambda
			real(wp), intent(inout) :: nr, ni
			real(wp) :: var, dummy
			integer(i4b) :: iloc
			
            iloc=find_pos(lam_h2o(1:n_rfrl),lambda)
            iloc=min(n_rfrl-1,iloc)
            iloc=max(1,iloc)
            
            
            ! linear interp nr
            call poly_int(lam_h2o(iloc:iloc+1), nr_h2o(iloc:iloc+1), &
                        max(min(lambda,lam_h2o(n_rfrl)),lam_h2o(1)), nr,dummy)
            ! linear interp ni
            call poly_int(lam_h2o(iloc:iloc+1), ni_h2o(iloc:iloc+1), &
                        max(min(lambda,lam_h2o(n_rfrl)),lam_h2o(1)), ni,dummy)
	
		end subroutine refractive_h2o
		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		!>@author
		!>Paul J. Connolly, The University of Manchester
		!>@brief
		!>real refractive index of water vs wavelength
		!>just a lookup table from 
		!>https://en.wikipedia.org/wiki/Optical_properties_of_water_and_ice#Refractive_Index,_Real_and_Imaginary_Parts_for_Liquid_Water
		!>@param[in] lambda
		function real_refractive_h2o(lambda)
			implicit none
			real(wp), dimension(:), intent(in) :: lambda
			real(wp), dimension(size(lambda)) :: real_refractive_h2o
			real(wp) :: var, dummy
			integer(i4b) :: iloc, i
			
			do i=1,size(lambda)
                iloc=find_pos(lam_h2o(1:n_rfrl),lambda(i))
                iloc=min(n_rfrl-1,iloc)
                iloc=max(1,iloc)
            
                ! linear interp nr
                call poly_int(lam_h2o(iloc:iloc+1), nr_h2o(iloc:iloc+1), &
                            max(min(lambda(i),lam_h2o(n_rfrl)),lam_h2o(1)),&
                            real_refractive_h2o(i),dummy)
            enddo
            	
		end function real_refractive_h2o
		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		
		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		!>@author
		!>Paul J. Connolly, The University of Manchester
		!>@brief
		!>imaginary refractive index of water vs wavelength
		!>just a lookup table from 
		!>https://en.wikipedia.org/wiki/Optical_properties_of_water_and_ice#Refractive_Index,_Real_and_Imaginary_Parts_for_Liquid_Water
		!>@param[in] lambda
		function imag_refractive_h2o(lambda)
			implicit none
			real(wp), dimension(:), intent(in) :: lambda
			real(wp), dimension(size(lambda)) :: imag_refractive_h2o
		    real(wp) :: var, dummy
			integer(i4b) :: iloc, i
			
			do i=1,size(lambda)
                iloc=find_pos(lam_h2o(1:n_rfrl),lambda(i))
                iloc=min(n_rfrl-1,iloc)
                iloc=max(1,iloc)
            
                ! linear interp ni
                call poly_int(lam_h2o(iloc:iloc+1), ni_h2o(iloc:iloc+1), &
                            max(min(lambda(i),lam_h2o(n_rfrl)),lam_h2o(1)), &
                            imag_refractive_h2o(i),dummy)
            enddo	
		end function imag_refractive_h2o
		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		
		
		



		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		!>@author
		!>Paul J. Connolly, The University of Manchester
		!>@brief
		!>Calculate if current year is leap year or not
		!>See https://support.microsoft.com/en-gb/help/214019/
		!            method-to-determine-whether-a-year-is-a-leap-year
		!>@param[in] year
		!>@param[inout] diy, leap
		subroutine leap_year_calc(year,diy,leap)
			implicit none
			integer(i4b), intent(in) :: year
			integer(i4b), intent(inout) :: diy
			logical, intent(inout) :: leap
			
			integer(i4b) :: i
			
			if(modulo(year,4) == 0) then ! step 1:
				if(modulo(year,100) == 0) then ! step 2:
					if(modulo(year,400) == 0) then ! step 3:
						! step 4:
						leap=.true. 
					else
						! step 5:
						leap=.false.
					endif
				else
					! step 4:
					leap=.true.
				endif
			else ! step 5:
				leap=.false. 
			endif
					
			if(leap) then
				diy=366
			else
				diy=365
			endif
			
		end subroutine leap_year_calc	
		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		!>@author
		!>Paul J. Connolly, The University of Manchester
		!>@brief
		!>Calculate if current year is leap year or not
		!>See https://support.microsoft.com/en-gb/help/214019/
		!            method-to-determine-whether-a-year-is-a-leap-year
		!>@param[in] year
		!>@param[inout] diy, leap
		subroutine doy_calc(year,mon,day,diy,doy, leap)
			implicit none
			integer(i4b), intent(in) :: year,mon,day, diy
			integer(i4b), intent(inout) :: doy
			logical, intent(in) :: leap
			
			integer(i4b) :: i
			
			! calculates the day of year and whether it is a leap year / day in year
			doy=0
			if (leap ) then
				do i=1,mon-1
					doy=doy+di_ml(i)
				enddo
			else
				do i=1,mon-1
					doy=doy+di_mn(i)
				enddo
			endif
			doy=doy+day
			
			
			
		end subroutine doy_calc	
		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		
		
		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		!>@author
		!>Paul J. Connolly, The University of Manchester
		!>@brief
		!>Determine current year, mon, day, hour, min, sec
		!>@param[in] year
		!>@param[inout] diy, leap
		subroutine determine_current_time(start_year,start_hour,&
										start_min, start_sec, time, doy, tod,diy, &
										year)
			implicit none
			integer(i4b), intent(in) :: start_year, start_hour, &
										start_min, start_sec
			real(wp), intent(in) :: time
			real(wp), intent(inout) :: tod
			integer(i4b), intent(inout) :: doy,diy, year
			real(wp) :: days_to_add, doy_c
			integer(i4b) :: diy_c, i
			logical :: leap
			
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			! doy                                                                        !
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			days_to_add=time / 86400._wp
			doy_c=real(doy_s,wp)+real(start_hour,wp)/24._wp+ &
					real(start_min,wp)/3600._wp+real(start_sec,wp)/86400._wp+&
					days_to_add
			call leap_year_calc(start_year,diy_c,leap)

			i=1
			do while (doy_c.gt.real(diy_c,wp))
				doy_c=doy_c-real(diy_c,wp)
				call leap_year_calc(start_year+i,diy_c,leap)
				i=i+1
			end do
			year=start_year+i-1
			doy=floor(doy_c)
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

			tod = (doy_c-real(doy,wp))*86400._wp
			diy=diy_c
			
		end subroutine determine_current_time
		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!										
										
										
		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		!>@author
		!>Paul J. Connolly, The University of Manchester
		!>@brief
		!>TOA irradiance
		!>See Jacobson, Fundamentals of Atmospheric Modelling, pp 325
		!>@param[in] day of year - doy
		!>@param[inout] frac - fraction of solar constant
		subroutine toa_solar_frac(doy,frac)
			implicit none
			real(wp), intent(in) :: doy
			real(wp), intent(inout) :: frac
			real(wp) :: th_j
			
			! equation 9.97 of Jacobson's book.
			th_j=2._wp*pi*(doy)/diy_exact ! doy=1 corresponds to 1st Jan
										  ! and not 22 dec.
										  ! note, diy is down as 365.25..., so not 100% 
										  ! accurate
			frac=1.00011_wp + 0.034221_wp*cos(th_j) + 0.00128_wp*sin(th_j) + &
					0.000719_wp*cos(2._wp*th_j)+0.000077_wp*sin(2._wp*th_j)
	
		end subroutine toa_solar_frac	
		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		!>@author
		!>Paul J. Connolly, The University of Manchester
		!>@brief
		!>solar zenith angle
		!>See Jacobson, Fundamentals of Atmospheric Modelling, pp 317
		!>an over simplification, but ok for non climate applications
		!>@param[inout] cosine of solar zenith angle
		!>@param[in] julian day of year - d_j 
		!            https://landweb.nascom.nasa.gov/browse/calendar.html
		!>@param[in] year - year
		!>@param[in] longitude, latitude
		!>@param[in] time - seconds in day (is adjusted to be past noon, in this func)
		subroutine solar_zenith(cos_theta_s,d_j,year, longitude, latitude, time)
			implicit none
			real(wp), intent(inout) :: cos_theta_s
			real(wp), intent(in) :: d_j, longitude, latitude
			real(wp), intent(in) :: year, time
			real(wp) :: th_j, d_l,n_jd, eps_ob, l_m, g_m, lambda_ec, time_local, ha_r, &
						delta_r

			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			! Obliquity of the ecliptic                                                  !
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			! equation 9.70 of Jacobson's book.
			if(year >= 2001) then
				d_l=int(year-2001._wp) / 4
			else
				d_l=int(year-2001._wp) / 4 - 1			
			endif		
			n_jd = 364.5_wp	+ (year-2001)*365._wp + d_l + d_j
			! equation 9.69 of Jacobson's book.
			! check this is correct - wikipedia different to Jacobson?:
			eps_ob = (23.439_wp-0.0000004_wp*n_jd)*pi/180._wp  
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			! ecliptic longitude of the Sun                                              !
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			! equation 9.72 of Jacobson's book.
			l_m = (280.460_wp + 0.9856474_wp*n_jd)
			g_m = (357.528_wp + 0.9856003_wp*n_jd)*pi/180._wp
			! equation 9.71 of Jacobson
			lambda_ec = (l_m + 1.915_wp*sin(g_m) + 0.020_wp*sin(2._wp*g_m))*pi/180._wp
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

			
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			! local hour angle                                              			 !
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			! longitude varies from -180 to 180
			time_local=time +longitude/180._wp*86400._wp
			! equation 9.73 of Jacobson's book.
			ha_r = 2._wp*pi*(time_local-86400._wp/2._wp)/86400._wp
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			! solar declination angle                                              	     !
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			! equation 9.68 of Jacobson's book.
			delta_r=asin(sin(eps_ob)*sin(lambda_ec))
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

			! equation 9.67 of Jacobson's book.
			cos_theta_s = sin(latitude*pi/180._wp)* &
						sin(delta_r)+cos(latitude*pi/180._wp)*cos(delta_r)*cos(ha_r)
	
		end subroutine solar_zenith
		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		!>@author
		!>Paul J. Connolly, The University of Manchester
		!>@brief
		!>calculate the in-band planck function at temperature t
		!>See http://www.spectralcalc.com/blackbody/inband_radiance.html 
		!>@param[inout] cosine of solar zenith angle
		!>@param[in] year - year
		!>@param[in] longitude, latitude
		!>@param[in] time - seconds in day (is adjusted to be past noon, in this func)
		subroutine inband_planck(nbands,lambda_low,lambda_high,temp,blt)
			implicit none
			integer(i4b), intent(in) :: nbands 
			real(wp), dimension(nbands), intent(inout) :: blt
			real(wp), dimension(nbands), intent(in) :: lambda_low, lambda_high
			real(wp), intent(in) :: temp
			
			integer(i4b) :: i,j
			real(wp) :: x_upper, x_lower, sum_upper, sum_lower, fac
			
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			! calculate the planck function in these bins				 				 !
			! see http://www.spectralcalc.com/blackbody/inband_radiance.html             !
			! note, the integral result is the same no matter form of BB function        !
			! but the value of x is what is in the exponential                           !
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			! fac_planck=2._wp*k_boltz**4/(h_planck**3*c_light**2)*pi
			fac=fac_planck * temp**4/pi
			do i=1,nbands
				x_upper=h_planck*c_light/(k_boltz*temp*lambda_high(i))
				x_lower=h_planck*c_light/(k_boltz*temp*lambda_low(i))
				sum_upper=0._wp
				do j=1,min(512 , 2+nint(20._wp/x_upper)) ! criteria on webpage
					sum_upper=sum_upper+(x_upper**3./real(j,wp) + &
							3._wp*x_upper**2./real(j,wp)**2 + &
							6._wp*x_upper/real(j,wp)**3 + &
							6._wp/real(j,wp)**4) * &
								exp(-real(j,wp)*x_upper)
				enddo
				
				sum_lower=0._wp
				do j=1,min(512 , 2+nint(20._wp/x_lower)) ! criteria on webpage
					sum_lower=sum_lower+(x_lower**3./real(j,wp) + &
							3._wp*x_lower**2./real(j,wp)**2 + &
							6._wp*x_lower/real(j,wp)**3 + &
							6._wp/real(j,wp)**4) * &
								exp(-real(j,wp)*x_lower)
				enddo
				blt(i) = fac*(sum_upper-sum_lower)

! 				call plancks_law(0.5_wp*(lambda_low(i)+lambda_high(i)),temp,blt(i))
! 				blt(i)=blt(i)*(lambda_high(i)-lambda_low(i))
			enddo
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		end subroutine inband_planck
		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			
			
		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		!>@author
		!>Paul J. Connolly, The University of Manchester
		!>@brief
		!>calculate the in-band planck function at temperature t
		!>See http://www.spectralcalc.com/blackbody/inband_radiance.html 
		!>Note that I fit an exponential curve to the approximation in inband_planck
		subroutine inband_planck_param(nbands,lambda_low,lambda_high,temp,blt)
			implicit none
			integer(i4b), intent(in) :: nbands 
			real(wp), dimension(nbands), intent(inout) :: blt
			real(wp), dimension(nbands), intent(in) :: lambda_low, lambda_high
			real(wp), intent(in) :: temp
			
			integer(i4b) :: i,j
			real(wp) :: x_upper, x_lower, sum_upper, sum_lower, fac
			
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			! calculate the planck function in these bins				 				 !
			! see http://www.spectralcalc.com/blackbody/inband_radiance.html             !
			! note, the integral result is the same no matter form of BB function        !
			! but the value of x is what is in the exponential                           !
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			fac=fac_planck * temp**4 / pi
			do i=1,nbands
				x_upper=h_planck*c_light/(k_boltz*temp*lambda_high(i))
				x_lower=h_planck*c_light/(k_boltz*temp*lambda_low(i))
				sum_upper=exp(-0.000000000633054_wp*x_upper**4 + &
				               0.000000950820139_wp*x_upper**3  &
				              -0.000489314838945_wp*x_upper**2  &
				              -0.890274259590316_wp*x_upper +  &
				              7.174105190082139_wp)
				
				sum_lower=exp(-0.000000000633054_wp*x_lower**4 + &
				               0.000000950820139_wp*x_lower**3  &
				              -0.000489314838945_wp*x_lower**2  &
				              -0.890274259590316_wp*x_lower +  &
				              7.174105190082139_wp)
				blt(i) = fac*(sum_upper-sum_lower)
				
			enddo
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		end subroutine inband_planck_param
		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			
			
		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		!>@author
		!>Paul J. Connolly, The University of Manchester
		!>@brief
		!> Use Mitchell (2000), JAS to calculate the extinction and absorption
        !> See equations 22 and 23 (although some changes needed)
        !>@param[in] ip,jp,kp,r_h, nbands,nrad
        !>@param[inout] sigma_s_clouds, sigma_a_clouds
        !>@param[in] ngs,mugs,lamgs,lambda,nrwbin,niwbin
        subroutine calculate_scattering_and_absorption(ip,jp,kp,r_h, &
                    nbands,nrad,sigma_s_clouds, &
                    sigma_a_clouds,ngs,mugs,lamgs,lambda,nrwbin,niwbin)
			implicit none
			integer(i4b), intent(in) :: nbands, nrad,ip, jp, kp, r_h
			real(wp), dimension(nbands), intent(in) :: lambda, nrwbin, niwbin
			real(wp), intent(in), &
					dimension(1-r_h:kp+r_h, 1-r_h:jp+r_h, 1-r_h:ip+r_h,1:nrad) :: &
					    ngs,lamgs, mugs
			real(wp), intent(inout), &
			        dimension(1-r_h:kp+r_h, 1-r_h:jp+r_h, 1-r_h:ip+r_h,1:nbands) :: &
			        sigma_s_clouds, sigma_a_clouds			
			! local variables:
			integer(i4b) :: i,j,k,m,n
			real(wp) :: gam_a_1,gam_a_2, gam_3,gam_4,gam_5,gam_6,gam_7, gam_m, &
			            g,e,e0,a1,a2,a3,a4,a5,a6,ra,rext, kmax, dmm, test
			real(wp), parameter :: mtun=0.5_wp, sigma=pi*0.25_wp
			complex(wp) :: q,ncom
			complex(wp), parameter :: imag1=complex(0._wp,1._wp)
			
			sigma_a_clouds=0._wp
			sigma_s_clouds=0._wp
			do m=1,nbands
			    g=8._wp*pi*niwbin(m)/(3._wp*lambda(m))
			    e0=0.25_wp+0.6_wp*(1._wp-exp(-8._wp*pi*niwbin(m)/3._wp))**2 ! eq 8
			    e=e0/lambda(m) ! equation 28
			    ra=0.7393_wp*nrwbin(m)-0.6069_wp ! equation 6
			    rext=ra*0.5_wp ! equation 11
			    a1=0.25_wp+0.25_wp*exp(-1167._wp*niwbin(m)) ! equation5
			    kmax=mtun/e0 ! equation 9
			    a2=ra/(kmax**mtun*exp(-mtun)*lambda(m)**mtun)
			    a3=rext/(kmax**mtun*exp(-mtun)*lambda(m)**mtun)
			    a4=0.06_wp*pi/lambda(m)
			    a5=(pi/lambda(m))**(-2._wp/3._wp)
			    a6=1._wp
			    ncom=complex(nrwbin(m),-niwbin(m))
			    q=imag1*(ncom-complex(1._wp,0._wp))*complex(2._wp*pi/lambda(m),0._wp)
			    do n=1,2 ! cloud, rain, ice
                    do i=1,ip
                        do j=1,jp
                            do k=1-r_h,kp+r_h
                                ! Arbitrary scattering parameters
!                                 if((k>30).and.(k<35)) then
!                                     sigma_s_clouds(k,j,i,m)=&
!                                         sigma*2._wp*100.e6*10.e-6_wp**2
!                                     sigma_a_clouds(k,j,i,m)=0._wp
!                                     if(m>16) then
!                                         sigma_a_clouds(k,j,i,m)= &
!                                             sigma_s_clouds(k,j,i,m)*1.0_wp
!                                     endif
!                                 else
!                                     sigma_s_clouds(k,j,i,m)=0._wp
!                                     sigma_a_clouds(k,j,i,m)=0._wp
!                                 endif     
!                                 cycle                           

                                if(isnan(lamgs(k,j,i,n))) cycle
                                if(isnan(mugs(k,j,i,n))) cycle
                                if(isnan(ngs(k,j,i,n))) cycle

                                ! babs here
                                gam_7=gamma(mtun+mugs(k,j,i,n)+1._wp)
                                gam_6=gam_7*(mtun+mugs(k,j,i,n)+1._wp) ! gamma m+mu+2
                                gam_5=gamma(mugs(k,j,i,n)+1._wp)
                                gam_4=gam_5*(mugs(k,j,i,n)+1._wp) ! gamma mu+2
                                gam_a_1=gam_4*(mugs(k,j,i,n)+2._wp) ! gamma mu+3
                                gam_m=gam_a_1*(mugs(k,j,i,n)+3._wp) ! gamma mu+4
                                gam_a_2=gamma(3._wp+mtun+mugs(k,j,i,n))
                                gam_3=gamma(mugs(k,j,i,n)+7._wp/3._wp)
                            
                                ! equation 22 
                                test= &
                                    sigma*ngs(k,j,i,n) * &
                                        gam_a_1 / &
                                        (lamgs(k,j,i,n)**(3._wp+mugs(k,j,i,n))) - &
                                    sigma*ngs(k,j,i,n) * &
                                        gam_a_1 / &
                                        ((lamgs(k,j,i,n)+g)**(3._wp+mugs(k,j,i,n))) + &
                                    a1*sigma*ngs(k,j,i,n) * &
                                        gam_a_1 / &
                                        ((lamgs(k,j,i,n)+g)**(3._wp+mugs(k,j,i,n))) - &
                                    a1*sigma*ngs(k,j,i,n) * &
                                        gam_a_1 / &
                                        ((lamgs(k,j,i,n)+2._wp*g)**(3._wp+mugs(k,j,i,n))) + &
                                    a2*sigma*ngs(k,j,i,n) * &
                                        gam_a_2 / &
                                        ((lamgs(k,j,i,n)+e)**(3._wp+mugs(k,j,i,n)+mtun)) - &
                                    a2*sigma*ngs(k,j,i,n) * &
                                        gam_a_2 / &
                                        ((lamgs(k,j,i,n)+e+g)**(3._wp+mugs(k,j,i,n)+mtun))

                                if(.not.isnan(test)) &
                                    sigma_a_clouds(k,j,i,m)=sigma_a_clouds(k,j,i,m)+test
                                ! bext here
                            
                                ! equation 23 - there is a change of sign of 
                                ! first term in re function
                                test= &
                                    pi*ngs(k,j,i,n)*gam_a_1 / &
                                        (2._wp*lamgs(k,j,i,n)**(3._wp+mugs(k,j,i,n))) + &
                                    a3*pi*ngs(k,j,i,n)*gam_a_2 / &
                                        (2._wp*(lamgs(k,j,i,n)+&
                                        e)**(3._wp+mugs(k,j,i,n)+mtun)) + &
                                    a6*sigma*a5*ngs(k,j,i,n)*gam_3*&
                                        (lamgs(k,j,i,n)**(-(mugs(k,j,i,n)+7._wp/3._wp))- &
                                        (lamgs(k,j,i,n)+a4)**(-(mugs(k,j,i,n)+7._wp/3._wp)))+&
                                    pi*ngs(k,j,i,n)*real( &
                                     complex(gam_4,0._wp) / &
                                     (q*(complex(lamgs(k,j,i,n),0._wp)+q)**(&
                                     complex(mugs(k,j,i,n)+2._wp,0._wp))) +&
                                     complex(gam_5,0._wp) / &
                                        (q*q)*((complex(lamgs(k,j,i,n),0._wp)+q)**(&
                                        -(complex(mugs(k,j,i,n)+1._wp,0._wp))) - &
                                        complex(lamgs(k,j,i,n),0._wp)**(&
                                        -complex(mugs(k,j,i,n)+1._wp,0._wp))),wp)+&
                                    a3*pi*ngs(k,j,i,n)*real( &
                                     complex(gam_6,0._wp) / &
                                     (q*(complex(lamgs(k,j,i,n)+e,0._wp)+q)**&
                                     complex(mugs(k,j,i,n)+mtun+2._wp,0._wp)) +&
                                     complex(gam_7,0._wp) / &
                                     (q*q)* &
                                        ((complex(lamgs(k,j,i,n)+e,0._wp)+q)**(&
                                        -complex(mugs(k,j,i,n)+mtun+1._wp,0._wp)) - &
                                        complex(lamgs(k,j,i,n)+e,0._wp)**(&
                                        -complex(mugs(k,j,i,n)+mtun+1._wp,0._wp))),wp)


                                if(.not.isnan(test)) &
                                    sigma_s_clouds(k,j,i,m)=sigma_s_clouds(k,j,i,m)+test
!                                 if(.not.isnan(test)) then
!                                     print *,test,sigma_a_clouds(k,j,i,m),mugs(k,j,i,n), &
!                                         lamgs(k,j,i,n),ngs(k,j,i,n),lambda(m)
!                                     pause
!                                 endif
                                ! Geometric approximation
!                                 sigma_s_clouds(k,j,i,m)=sigma_s_clouds(k,j,i,m)+&
!                                     sigma* &
!                                     2._wp*ngs(k,j,i,n)*gamma(mugs(k,j,i,n)+3._wp) / &
!                                     lamgs(k,j,i,n)**(mugs(k,j,i,n)+3._wp)
                                
                            enddo
                        enddo
                    enddo
                enddo
            enddo
            ! we need scattering, not extinction
            sigma_s_clouds=sigma_s_clouds-sigma_a_clouds
        end subroutine calculate_scattering_and_absorption
		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		!>@author
		!>Paul J. Connolly, The University of Manchester
		!>@brief
		!> solve fluxes, using
		!>tridiagonal solver for two-stream method
		!> \f$ \begin{bmatrix} 
        !>        1  & -A_e & 0 & 0 & 0 & 0 & \cdots\\
        !>        A_k & B_k & C_k & 0 & 0 & 0 & \cdots\\
        !>        0 & E_k & F_k & G_k & 0 & 0  & \cdots\\
        !>        0 & 0 & A_{k+1} & B_{k+1} & C_{k+1} & 0  & \cdots\\
        !>        \vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \vdots \\
        !>        0 & 0 & 0 & 0 &0 & 0 & 1   \\
        !>   \end{bmatrix}
        !>   \begin{bmatrix}
        !>   F^+_{k-{1/2}} \\F^-_{k-{1/2}} \\F^+_{k+{1/2}} \\
        !>   F^-_{k+{1/2}} \\\vdots \\F^-_{kp+{1/2}} \\
        !>   \end{bmatrix} = 
        !>   \begin{bmatrix}
        !>   A_e\mu_sF_s\exp\left(-\tau / \mu_s \right) +\epsilon \pi B_T\\
        !>   D_k \\H_k \\
        !>   D_{k+1} \\ \vdots \\\mu F_s \\
        !>   \end{bmatrix} 
        !>   \f$
        !>@param[in] comm3d,id, dims, coords: mpi stuff
		subroutine solve_fluxes(start_year,start_mon,start_day, &
								start_hour,start_min,start_sec, &
								lat, lon, &
								time, nbands,ns,nl,ip,jp,kp,r_h, &
								tdstart,tdend,a,b,c,r,u, &
								lambda_low, lambda_high, lambda,nrwbin, niwbin, &
								b_s_g, sflux_l,&
								nq,q, &
								rhoan, tref, trefn, dz,dzn, albedo, emiss, &
								quad_flag, gas_absorption, &
								nmolecule, nweights, npress, ntemp, nh2o, &
								itemp,ipress,bli_read, probs_read, h2o_read, &	
								moleculeID, moleculePPM, molecularWeights, &							
								th, flux_u, flux_d, &
								asymmetry_water, nrad, ngs,lamgs,mugs, &
								cloud_flag, &
								nprocv,mvrecv, &
								coords,dims, id, comm3d)
			use numerics, only : tridiagonal
			use mpi
			use pts
			implicit none
			logical, intent(in) :: gas_absorption
			integer(i4b), intent(in) :: start_year, start_mon, start_day, start_hour, &
							start_min, start_sec
			real(wp), intent(in) :: time
			integer(i4b), intent(in) :: nbands, ns, nl, ip, jp, kp, r_h, nprocv, &
			        nmolecule, nweights, npress, ntemp, nh2o			
            integer(i4b), intent(in), dimension(1-r_h:kp+r_h) :: itemp, ipress
            real(wp), intent(in), dimension(1:nbands,1:nmolecule,1:nweights, &
                        1:ntemp,1:npress, 1:nh2o) :: bli_read
            real(wp), intent(in), dimension(1:nweights) :: probs_read
            real(wp), intent(in), dimension(1:nh2o) :: h2o_read
            integer(i4b), intent(in), dimension(1:nmolecule) :: moleculeID
            real(wp), intent(in), dimension(1:nmolecule) :: moleculePPM, molecularWeights

			real(wp), intent(in), dimension(nprocv) :: mvrecv
			real(wp), dimension(nbands), intent(in) :: &
					lambda_low, lambda_high, lambda, nrwbin, niwbin, b_s_g, sflux_l
			real(wp), intent(in), dimension(1-r_h:kp+r_h) :: rhoan, trefn, tref, dz,dzn
			real(wp), intent(in), &
					dimension(1-r_h:kp+r_h, 1-r_h:jp+r_h, 1-r_h:ip+r_h) :: th
			real(wp), intent(inout), &
					dimension(1-r_h:kp+r_h, 1-r_h:jp+r_h, 1-r_h:ip+r_h,1:nbands) :: &
					flux_u, flux_d
		    integer(i4b), intent(in) :: nq
			real(wp), intent(in), &
					dimension(1-r_h:kp+r_h, 1-r_h:jp+r_h, 1-r_h:ip+r_h,1:nq) :: q
			real(wp), intent(in), &
					dimension(1-r_h:kp+r_h, 1-r_h:jp+r_h, 1-r_h:ip+r_h,1:nrad) :: &
					    ngs,lamgs, mugs
			real(wp), intent(in) :: lat, lon, albedo, emiss, asymmetry_water
			integer(i4b), intent(in) :: quad_flag, nrad

            integer(i4b), dimension(3), intent(in) :: coords
            integer(i4b), dimension(3), intent(in) :: dims
            integer(i4b), intent(in) :: id, comm3d
            
            integer(i4b), intent(in) :: tdstart,tdend
            real(wp), dimension(1:tdend), intent(inout) :: a,b,c,r,u
            logical, intent(in) :: cloud_flag

			
			! local variables:
			integer(i4b) :: doy,diy, year,error
			real(wp) :: tod, cos_theta_s, frac,msend, mu1, factor, alpha1, alpha2, &
			    k_exponent, mu0_local, od_over_mu0, k_mu0, k_gamma3, k_gamma4, &
			    exponential0, exponential, exponential2, k_2_exponential, &
			    reftrans_factor, coeff, coeff_up_top, coeff_dn_top, coeff_up_bot, &
			    coeff_dn_bot, &
			    tau_store1, a_abs, uq, ev
			real(wp), dimension(1:kp+1) :: sigma_ray, sigma_tot,taun,dtau,dtaun, &
			                                sigma_abs_gas, tau_store
			real(wp), dimension(1:kp+1) :: tau, ref_diff, trans_dir_dir, trans_diff, &
			    ref_dir, trans_dir_diff, inv_denominator
			real(wp), dimension(kp+1,nbands) :: blt, blt_top, blt_bot
			real(wp), dimension(nbands) :: blt_surf ! blt at the surface
			real(wp), dimension(1-r_h:kp+r_h, 1-r_h:jp+r_h, 1-r_h:ip+r_h,1:nbands) :: &
			        sigma_s_clouds, sigma_a_clouds
			real(wp), dimension(1-r_h:kp+r_h) :: gamma1_sw, gamma2_sw, gamma3_sw, &
			    gamma4_sw, gamma1_lw, gamma2_lw, omg_s, ga, &
			    reflectance, transmittance, source_up, source_dn, source, albedo_atmos, &
			    flux_dn_direct, flux_dn_diffuse, flux_up
			logical :: leap
			
			integer(i4b) :: it, itermax=1, k, m,j,i,qgas,kend,kstart, shortWave, ih2o
			
			
			
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			! determine parameters for sun position                                      !
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			call determine_current_time(start_year,start_hour,&
						start_min, start_sec, time, doy, tod,diy, year)	
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			! determine toa, solar zenith:                                               !
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
			call toa_solar_frac(real(doy,wp),frac)
			call solar_zenith(cos_theta_s,real(doy,wp),real(year,wp), lon, lat, tod)
			!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!



            kend=kp+1
            !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
            ! Calculate the absorption and extinction for clouds
            if(cloud_flag) then
                call calculate_scattering_and_absorption(ip,jp,kp,r_h, &
                    nbands,nrad,sigma_s_clouds, &
                    sigma_a_clouds,ngs,mugs,lamgs,lambda,nrwbin,niwbin)
            endif
            !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

            do m=1,nbands            
                !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                ! extinction:							    					         !
                !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                do k=1,kp 
                    ! number of molecules per cubic metre of air multiplied by 
                    ! collision cross-section:
                    sigma_ray(k)=rhoan(k)*navog/ma*b_s_g(m)
                enddo
                !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

                !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                ! absorption by gases (everything except water vapour):					 !
                !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                do k=1,kp
                    tau_store(k)=1._wp
                    do qgas=2,nmolecule
                        ! calculate the pathlength
                        uq=rhoan(k)*molecularWeights(qgas)/(ma*1000._wp)* &
                            moleculePPM(qgas)*dz(k)*1.e-7_wp
                        
                        a_abs = sum(probs_read*(1._wp-exp( &
                            -uq*bli_read(m,qgas,:,itemp(k),ipress(k),1) ))) / &
                            sum(probs_read)
                        tau_store(k) = tau_store(k)*(1._wp-a_abs)
                    enddo
                enddo
                !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

                do i=1,ip
                    do j=1,jp
                    
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        ! absorption by gases (everything except water vapour):			 !
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        if(moleculePPM(1).ge.0._wp) then
                            do k=1,kp
                                ! calculate the partial pressure
                                ev = rhoan(k)*ra*trefn(k)*moleculePPM(1)/1.e6_wp
                                ih2o=1
                                if(ev.gt.h2o_read(1)) ih2o=2
                                ! calculate the pathlength
                                uq=rhoan(k)*molecularWeights(1)/(ma*1000._wp)* &
                                    moleculePPM(1)*dz(k)*1.e-7_wp

                                a_abs = sum(probs_read*(1._wp-exp( &
                                    -uq*bli_read(m,1,:,itemp(k),ipress(k),ih2o) ))) / &
                                    sum(probs_read)
                                tau_store1 = tau_store(k)*(1._wp-a_abs)
                                tau_store1=-log(tau_store1)
                                sigma_abs_gas(k)=tau_store1/dz(k)
                            enddo
                        else
                            do k=1,kp
                                ! calculate the partial pressure
                                ev = q(k,j,i,1)*rhoan(k)*rv*trefn(k)
                                ih2o=1
                                if(ev.gt.h2o_read(1)) ih2o=2
                                ! calculate the pathlength
                                uq=q(k,j,i,1)*rhoan(k)*dz(k)*1.e-1_wp

                                a_abs = sum(probs_read*(1._wp-exp( &
                                    -uq*bli_read(m,1,:,itemp(k),ipress(k),ih2o) ))) / &
                                    sum(probs_read)
                                tau_store1 = tau_store(k)*(1._wp-a_abs)
                                tau_store1=-log(tau_store1)
                                sigma_abs_gas(k)=tau_store1/dz(k)
                            enddo                        
                        endif
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        ! calculate planck function at all levels bottom-points:	     !
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        do k=1,kp
                            call inband_planck(1,lambda_low(m),lambda_high(m), &
                                    tref(k-1)+0.5_wp*(th(k-1,j,i)+th(k,j,i)),blt_bot(k,m))
                        enddo
                        do k=1,kp
                            call inband_planck(1,lambda_low(m),lambda_high(m), &
                                    tref(k)+0.5_wp*(th(k,j,i)+th(k+1,j,i)),blt_top(k,m))
                        enddo
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        ! calculate planck function at surface          			     !
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        if(coords(3)==0) then
                            call inband_planck(1,lambda_low(m),lambda_high(m), &
                                                    tref(0),blt_surf(m))
                        endif
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!




                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        ! extinction and absorption:							    	 !
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        do k=1,kp
                            sigma_tot(k)=sigma_ray(k)
                            if(cloud_flag) then
                                sigma_tot(k)=sigma_tot(k)+(sigma_s_clouds(k,j,i,m) + &
                                    sigma_a_clouds(k,j,i,m))
                            endif
                            if(gas_absorption) sigma_tot(k)=sigma_tot(k)+sigma_abs_gas(k)
                        enddo
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

        
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        ! optical depth, etc:					    				     !
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        do k=1,kp+1
                            ! equation 9.103, Jacobson - single scattering albedo
                            omg_s(k)=min((sigma_ray(k)+sigma_s_clouds(k,j,i,m)) / &
                                (sigma_tot(k)),1._wp-1.e-10_wp)

                            ! equation 9.117, Jacobson - effective asymmetry param
                            ga(k)=(sigma_s_clouds(k,j,i,m)*asymmetry_water) / &
                                (sigma_ray(k)+sigma_s_clouds(k,j,i,m)) 

                            tau(k)=sigma_tot(k)*dz(k)
                        enddo

                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        ! delta scaling                                                  !
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        if (deltaScaling) then 
                            do k=1,kp+1
                                ! delta scaling - page 332, Jacobson
                                tau(k)=(1._wp-omg_s(k)*ga(k)*ga(k))*tau(k)
                                omg_s(k)=(1._wp-ga(k)*ga(k))*omg_s(k)/ &
                                    (1._wp-omg_s(k)*ga(k)*ga(k))
                                ga(k)=ga(k)/(ga(k)+1._wp)
                            enddo
                        endif
                        if (coords(3)==(dims(3)-1)) then
                            tau(kp+1)=1.e-2_wp
                        endif            
            
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        ! diffuse phase function scaling on p-points:   			     !
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        do k=1,kp
                            factor=0.75_wp*ga(k)
                            gamma1_sw(k)=2._wp-omg_s(k)*(1.25_wp+factor)
                            gamma2_sw(k)=omg_s(k)*(0.75_wp-factor)
                            gamma3_sw(k)=0.5_wp-cos_theta_s*factor
                            gamma4_sw(k)=1._wp-gamma3_sw(k)
                        enddo
                        do k=1,kp
                            factor=1.66_wp*0.5_wp*omg_s(k)
                            gamma1_lw(k)=1.66_wp-factor*(1._wp+ga(k))
                            gamma2_lw(k)=factor*(1._wp-ga(k))
                        enddo
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                    
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        ! Meador and Weaver (1980) reflectance, transmittance and sources!
                        ! for longwave     			                                     !
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        do k=1,kp
                            if(tau(k)>1.e-3_wp) then
                                k_exponent=sqrt(max((gamma1_lw(k)-gamma2_lw(k))* &
                                    (gamma1_lw(k)+gamma2_lw(k)),1.e-12_wp ))
                                exponential=exp(-k_exponent*tau(k))
                                exponential2=exponential*exponential
                                reftrans_factor=1._wp / &
                                    (k_exponent+gamma1_lw(k)+ &
                                    (k_exponent-gamma1_lw(k))*exponential2)
                                ! M+W (1980), eq. 25
                                reflectance(k) = gamma2_lw(k)*(1._wp-exponential2)* &
                                    reftrans_factor
                                ! M+W(1980), eq. 26
                                transmittance(k)=2._wp*k_exponent*exponential* &
                                    reftrans_factor
                                    
                                ! upward and downward emission assuming Planck function
                                ! varies linearly with OD within the layer 
                                ! (Wiscombe, JQSRT 1976)
                                ! From Stackhouse and Stephens (JAS 1991) eq. 5 and 12?
                                coeff = pi*(blt_bot(k,m)-blt_top(k,m)) / &
                                    (tau(k)*(gamma1_lw(k)+gamma2_lw(k)))
                                coeff_up_top =  coeff + pi*blt_top(k,m)
                                coeff_up_bot =  coeff + pi*blt_bot(k,m)
                                coeff_dn_top = -coeff + pi*blt_top(k,m)
                                coeff_dn_bot = -coeff + pi*blt_bot(k,m)
                                source_up(k) = coeff_up_top - &
                                    reflectance(k)*coeff_dn_top - &
                                    transmittance(k)*coeff_up_bot
                                source_dn(k) = coeff_dn_bot - &
                                    reflectance(k)*coeff_up_bot - &
                                    transmittance(k)*coeff_dn_top
                            else
                                ! eq. 18 of M+W (1980)
                                k_exponent = sqrt(max((gamma1_lw(k)- &
                                    gamma2_lw(k))*(gamma1_lw(k)+gamma2_lw(k)), 1.e-12_wp))
                                reflectance(k)=gamma2_lw(k)*tau(k)
                                transmittance(k)=(1._wp-k_exponent*tau(k)) / &
                                    (1._wp+tau(k)*(gamma1_lw(k)-k_exponent))
                                source_up(k)=(1._wp-reflectance(k)-transmittance(k)) * &
                                    0.5_wp*(blt_top(k,m)+pi*blt_bot(k,m))
                                source_dn(k)=source_up(k)
                            
                            endif
                        enddo
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        
                        
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        ! Solution using the adding method:                              !
                        ! can't parallelize in vertical                                  !
                        ! 1. Longwave radiation                                          !
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        albedo_atmos(0)=albedo
                        ! at the surface, the source is thermal emission
                        source(0)=emiss*pi*blt_surf(m)
                        
                        ! work up through the atmosphere and compute the albedo of the 
                        ! entire earth / atmosphere system below that half-level and also
                        ! the source, which is the upwelling flux due to emission below
                        ! that level
                        do k=1,kp
                            ! lacis and hansen (1974) eq. 33, Shonk and Hogan (2008) eq 10
                            inv_denominator(k)=1._wp/(1._wp-albedo_atmos(k-1)* &
                                reflectance(k))
                            ! shonk and hogan (2008), eq. 9; Petty (2006) eq 13.81
                            albedo_atmos(k)=reflectance(k)+ &
                                transmittance(k)*transmittance(k)*albedo_atmos(k-1)* &
                                inv_denominator(k)
                            ! shonk and hogan (2008), eq. 11
                            source(k)=source_up(k)+transmittance(k)* &
                                (source(k-1)+albedo_atmos(k-1)*source_dn(k))* &
                                inv_denominator(k)
                        enddo
                        ! toa, no diffuse downwelling
                        flux_d(kp,j,i,m)=0._wp
                        
                        ! toa, all upwelling is due to emission below that level
                        flux_u(kp,j,i,m)=source(kp)
                        
                        ! work down through the atmosphere computing the fluxes at each 
                        ! half-level
                        do k=kp,1,-1
                            ! shonk and hogan (2008) eq. 14 after simplification
                            flux_d(k-1,j,i,m)=(transmittance(k)*flux_d(k,j,i,m)+ &
                                reflectance(k) * &
                                source(k-1)+source_dn(k))*inv_denominator(k)
                            ! shonk and hogan (2008) eq. 12
                            flux_u(k-1,j,i,m)=albedo_atmos(k-1)* &
                                flux_d(k-1,j,i,m)+source(k-1)
                        enddo
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!                         flux_u(:,j,i,m)=0._wp
!                         flux_d(:,j,i,m)=0._wp
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        ! Meador and Weaver (1980) reflectance and transmittance         !
                        ! for shortwave   			                                     !
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        do k=1,kp
                            ! eq. 16 M+W (1980)
                            alpha1=gamma1_sw(k)*gamma4_sw(k) + gamma2_sw(k)*gamma3_sw(k)
                            ! eq. 17 M+W (1980)
                            alpha1=gamma1_sw(k)*gamma3_sw(k) + gamma2_sw(k)*gamma4_sw(k)
                            ! eq. 18 M+W (1980)
                            k_exponent = sqrt(max((gamma1_sw(k)-gamma2_sw(k))* &
                                (gamma1_sw(k)+gamma2_sw(k)), 1.e-12_wp ))
                            
                            mu0_local = cos_theta_s
                            ! if k*cos_theta_s is very close to 1 then ref_dif and 
                            ! trans_dif_diff can be outside 0-1
                            if(abs(1._wp-k_exponent*cos_theta_s) < 1000._wp*eps1) &
                                mu0_local = cos_theta_s*(1._wp-10._wp*eps1)
                                
                            od_over_mu0 = max(tau(k)/mu0_local, 0._wp)
                            k_mu0 = k_exponent*mu0_local
                            k_gamma3 = k_exponent*gamma3_sw(k)
                            k_gamma4 = k_exponent*gamma4_sw(k)
                            
                            exponential0=exp(-od_over_mu0)
                            ! transmission of direct radiation to direct radiation
                            trans_dir_dir(k)=exponential0
                            exponential=exp(-k_exponent*tau(k))
                            
                            exponential2=exponential*exponential
                            k_2_exponential = 2._wp*k_exponent*exponential
                            reftrans_factor = 1.0_wp/(k_exponent+gamma1_sw(k)+ &
                                (k_exponent-gamma1_sw(k))*exponential2)      
                                
                            ! M+W (1980) eq. 25
                            ref_diff(k)=gamma2_sw(k)*(1._wp-exponential2)*reftrans_factor                      
                            ! M+W (1980) eq. 26
                            trans_diff(k)=k_2_exponential*reftrans_factor  
                            
                            ! because we assume the incoming "direct" flux comes into a 
                            ! plane perp. to the sun, we need to multiply by mu0 as 
                            ! diffuse fluxes are always perp. to the ground - Robin Hogan
                            ! (Personal Communication)
                            reftrans_factor = mu0_local*omg_s(k)*reftrans_factor / &
                                (1._wp-k_mu0*k_mu0)
                                
                            ! M+W (1980) eq. 14. multiplying top and bottom by 
                            ! exp(-k_exponent*tau(i)) in case of very high optical depths
                            ! Reflectance to direct radiation
                            ref_dir(k)=reftrans_factor*((1._wp-k_mu0)*(alpha2+k_gamma3)- &
                                (1._wp+k_mu0)*(alpha2-k_gamma3)*exponential2 - &
                                k_2_exponential*(gamma3_sw(k)-alpha2*mu0_local)* &
                                exponential0)
                            
                            ! M+W (1980) eq. 15. multiplying top and bottom by 
                            ! exp(-k_exponent*tau(k)), minus the exp(-tau(k)/mu0) term
                            ! representing direct unscattered transmittance.
                            trans_dir_diff(k)=reftrans_factor*(k_2_exponential* &
                                (gamma4_sw(k)+alpha1*mu0_local)- &
                                    exponential0*((1._wp+k_mu0)*(alpha1+k_gamma4)- &
                                    (1._wp-k_mu0)*(alpha1-k_gamma4)*exponential2) )
                            ! final check that ref_dir + trans_dir_diff <=1.
                            ref_dir(k)=max(0._wp,min(trans_dir_diff(k), 1._wp-ref_dir(k)))
                            trans_dir_diff(k)=&
                                max(0._wp,min(trans_dir_diff(k),1._wp-ref_dir(k)))
                        enddo                        
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        ! Solution using the adding method:                              !
                        ! can't parallelize in vertical                                  !
                        ! 2. Shortwave radiation                                         !
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        if ((cos_theta_s <= 0._wp)) cycle
                        ! direct beam 
                        flux_dn_direct(kp)=sflux_l(m)*exp(-tau(kp+1)/mu0_local)
                        do k=kp,1,-1
                            flux_dn_direct(k-1)=flux_dn_direct(k)*trans_dir_dir(k)
                        enddo
                        
                        ! Diffuse source at the surface - direct beam reflected back into 
                        ! the diffuse stream
                        source(0)=albedo*flux_dn_direct(0)*cos_theta_s
                        
                        ! work up through the atmosphere and compute the albedo of the
                        ! earth / atmosphere system below that half-level and also the 
                        ! source, which is the upwelling flux due to the direct radiation
                        ! that is scattered below that level.
                        albedo_atmos(0)=albedo
                        do k=1,kp
                            ! lacis and hansen, eq 33; shonk and hogan (2008) eq 10
                            inv_denominator(k)=1._wp/(1._wp-albedo_atmos(k-1)* &
                                ref_diff(k))
                            ! shonk and hogan (2008), eq 9, petty (2006) eq 13.81
                            albedo_atmos(k)=ref_diff(k)+ &
                                trans_diff(k)*trans_diff(k)*albedo_atmos(k-1)* &
                                inv_denominator(k)
                            source(k)=ref_dir(k)*flux_dn_direct(k)+trans_diff(k)* &
                                (source(k-1)+albedo_atmos(k-1)*trans_dir_diff(k)* &
                                flux_dn_direct(k))*inv_denominator(k)
                        enddo
                        ! at the toa there is no diffuse downwelling radiation
                        flux_dn_diffuse(kp)=0._wp
                        
                        ! at the toa, all upwelling radiation is due to scattering by the
                        ! direct beam below that level
                        flux_up(kp)=source(kp)
                        
                        ! work down through the atmosphere computing the fluxes at each
                        ! half-level
                        do k=kp,1,-1
                            ! shonk and hogan (2008) eq. 14 (after simplication)
                            flux_dn_diffuse(k-1)=(trans_diff(k)*flux_dn_diffuse(k)+ &
                                ref_diff(k)*source(k-1)+&
                                trans_dir_diff(k)*flux_dn_direct(k))*inv_denominator(k)
                            ! shonk and hogan (2008) eq 12
                            flux_up(k-1)=albedo_atmos(k-1)*flux_dn_diffuse(k-1)+ &
                                source(k-1)
                            flux_dn_direct(k)=flux_dn_direct(k)*cos_theta_s
                        enddo
                        flux_dn_direct(0)=flux_dn_direct(0)*cos_theta_s
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        ! Finally, add shortwave fluxes to lw                            !
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        do k=0,kp
                            flux_d(k,j,i,m)=flux_d(k,j,i,m)+&
                                flux_dn_direct(k)+flux_dn_diffuse(k)
                            flux_u(k,j,i,m)=flux_u(k,j,i,m)+flux_up(k)
                        enddo                        
                        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                    enddo
                enddo
            enddo
		end subroutine solve_fluxes
		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


	end module radiation
	
